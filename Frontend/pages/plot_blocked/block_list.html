<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Block List | Aishalaya</title>
    <link rel="shortcut icon" href="../../assets/images/aishLogo.ico" />

    <!-- plugins:css -->
    <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End Plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="http://127.0.0.1:5500/assets/css/style.css">
 
    <!-- End layout styles -->

    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!--<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>-->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <!--showalert Message-->
    <script src="http://127.0.0.1:5500/assets/js/alertMessages.js"></script>
 
   
    <style>
        /* Adjust the modal size */
        .modal-dialog {
            max-width: 1400px;
            /* Set your desired maximum width */
        }

        /* Adjust the form size */
        .form-sample {
            max-width: 100%;
            /* Set your desired maximum width */
        }

        @media (min-width: 576px) {
            .col-sm-9 {
                -webkit-box-flex: 0;
                -ms-flex: 0 0 auto;
                flex: 0 0 auto;
                width: 60% !important;
            }
        }
    </style>
</head>

<body>
    <div class="container-scroller">
        <!-- partial:../../partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
                <a class="navbar-brand brand-logo" href="../../index.html"><img src="../../assets/images/logo.png"
                        alt="logo" style="height: 100%;" /></a>
                <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="../../assets/images/logo.png"
                        alt="logo" style="height: 100%;" /></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-stretch">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="mdi mdi-menu"></span>
                </button>
                <ul class="navbar-nav navbar-nav-right">
                    <li class="nav-item d-none d-lg-block full-screen-link">
                        <a class="nav-link">
                            <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
                        </a>
                    </li>
                    <li class="nav-item nav-logout d-none d-lg-block">
                        <a class="nav-link" onclick="logout()">
                            <i class="mdi mdi-power"></i>
                        </a>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
                    data-toggle="offcanvas">
                    <span class="mdi mdi-menu"></span>
                </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <div id="includeHtml"></div>


            <!-- Company Form-->
            <div class="modal fade" id="companyModal" tabindex="-1" role="dialog" aria-labelledby="companyModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="companyModalLabel">Block Details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                                onclick="closeForm()">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="row">
                                <div class="col-5 offset-md-1 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">CUSTOMER DETAILS :</h4>

                                            <form id="customerForm" class="forms-sample">
                                                <div class="form-group row">
                                                    <label for="customerName" class="col-sm-4 col-form-label"
                                                        style="margin-top: 30px;">Name</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="customerName"
                                                            placeholder="Name" style="margin-top: 30px;">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="mobileNumber" class="col-sm-4 col-form-label">Mobile
                                                        Number</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="mobileNumber"
                                                            placeholder="mobileNumber">
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label for="employeeType"
                                                        class="col-sm-4 col-form-label">Occupation</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="employeeType"
                                                            placeholder="occupation">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="workPlace" class="col-sm-4 col-form-label">Work
                                                        Place</label>
                                                    <div class="col-sm-9">
                                                        <input type="workPlace" class="form-control" id="workPlace"
                                                            placeholder="workPlace">
                                                    </div>
                                                </div>


                                                <div class="form-group row">
                                                    <label for="address" class="col-sm-4 col-form-label">Address
                                                        :</label>
                                                    <div class="col-sm-9">
                                                        <textarea class="form-control" id="address" rows="3"
                                                            placeholder="address" style="width: 99%;"></textarea>
                                                    </div>

                                                </div>
                                                <div class="form-group row">
                                                    <label for="email" class="col-sm-4 col-form-label">Email
                                                        :</label>
                                                    <div class="col-sm-8 input-group" d-flex>
                                                        <input type="email" class="form-control" id="email"
                                                            placeholder="email">
                                                        <div class="input-group-append">
                                                            <a href="mailto:recipient@example.com?subject=Subject%20Here&body=Body%20of%20the%20email"
                                                                class="btn btn-primary">Compose</a>
                                                        </div>
                                                    </div>
                                                </div>

                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5  grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">VISIT DETAILS :</h4>


                                            <form id="companyForm" class="forms-sample">
                                                <div class="form-group row">
                                                    <label for="cab" class="col-sm-4 col-form-label"
                                                        style="margin-top: 30px;">Cab</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="cab"
                                                            placeholder="cab" name="cab" style="margin-top: 30px;">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="driver" class="col-sm-4 col-form-label">Driver</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="driver"
                                                            placeholder="Driver" name="driver">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="startingKms" class="col-sm-4 col-form-label">Starting
                                                        Kms</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="startingKms"
                                                            placeholder="startingKms" name="startingKms">
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label for="endKms" class="col-sm-4 col-form-label">Ending
                                                        Kms</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="endKms"
                                                            placeholder="endKms" name="endKms">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="employeeNotes" class="col-sm-4 col-form-label">Employee
                                                        Notes</label>

                                                    <div class="col-sm-9">
                                                        <textarea class="form-control" id="employeeNotes" rows="3"
                                                            placeholder="employeeNotes" style="width: 99%;"
                                                            name="employeeNotes"></textarea>
                                                    </div>

                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>


                            </div>

                            <!-- Company Form -->
                            <div class="row">
                                <div class="col-md-5 offset-md-1 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">EMPLOYEE DETAILS :</h4>

                                            <form class="forms-sample">
                                                <div class="form-group row">
                                                    <label for="employeeName" class="col-sm-4 col-form-label"
                                                        style="margin-top: 30px;">Employee Name</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="employeeName"
                                                            placeholder="projectNamecompanyName"
                                                            style="margin-top: 30px;">
                                                    </div>
                                                </div>


                                                <div class="form-group row">
                                                    <label for="alterMobile"
                                                        class="col-sm-4 col-form-label">Mobile</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="alterMobile"
                                                            placeholder="Address">
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label for="createdBy" class="col-sm-4 col-form-label">Created
                                                        By</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="createdBy"
                                                            placeholder="Password">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="prefLocation"
                                                        class="col-sm-4 col-form-label">Location</label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="prefLocation"
                                                            placeholder="launchDate">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="employeeEmail" class="col-sm-4 col-form-label">Email
                                                        :</label>
                                                    <div class="col-sm-8 input-group" d-flex>
                                                        <input type="email" class="form-control" id="employeeEmail"
                                                            placeholder="email" style="width: 10%;">
                                                        <div class="input-group-append">
                                                            <a href="mailto:recipient@example.com?subject=Subject%20Here&body=Body%20of%20the%20email"
                                                                class="btn btn-primary">Compose</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div> <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <h3 class="page-title">Block LIST </h3><br />

                    <div class="page-header">
                        <!--<h3 class="page-title">Site Visit List</h3><br/>-->

                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <div>

                                    <a href="blockReleased_list.html" class="btn btn-info btn-sm releaseBlock-btn"
                                        id="releaseBlockButton">Manually Realeased Blocks list</a>
                                    <a href="blockReleasedAutomatically_list.html"
                                        class="btn btn-info btn-sm releaseBlock-btn"
                                        id="releaseBlockButtonAutomatically">Automatically Realeased Blocks list</a>
                                </div>

                                <button class="btn btn-info btn-sm filter-btn" id="filterButton">Filter</button>
                                <div id="filterFields" style="display: none;">

                                    <div class="row">
                                        <div class="col">
                                            <input type="date" class="form-control custom-input" aria-label="From Date"
                                                id="fromDate">
                                        </div>
                                        <div class="col">
                                            <input type="date" class="form-control custom-input" aria-label="To Date"
                                                id="toDate" placeholder="To">
                                        </div>
                                        <div class="col">
                                            <input type="text" class="form-control custom-input" aria-label="mobile"
                                                id="mobile" placeholder="Mobile No">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control custom-input"
                                                aria-label="filtercustomerNames" id="filtercustomerNames"
                                                placeholder="customerNames">
                                        </div>
                                        <div class="col">
                                            <input type="text" class="form-control custom-input"
                                                aria-label="filterEmployeeNames" id="filterEmployeeNames"
                                                placeholder="EmployeeName">
                                        </div>
                                        <!--   <div class="col">
                                            <input type="text" class="form-control" aria-label="buyingDurationFilter"
                                                id="buyingDurationFilter" placeholder="Buying Duration">
                                        </div>
                                        <div class="col">
                                            <input type="text" class="form-control" aria-label="fundingResourceFilter"
                                                id="fundingResourceFilter" placeholder="fundingResourceFilter">
                                        </div>-->
                                        <div class="col">
                                            <input type="text" class="form-control custom-input" placeholder="Search..."
                                                aria-label="Search" aria-describedby="search-button" id="searchInput">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="search-button">Search</button>
                                        </div>
                                    </div>
                                </div>



                            </ol>

                        </nav>
                    </div>
                    <div class="row">

                        <div class="col-lg-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <div class="template-demo">

                                    </div>
                                    <div class="table-responsive">
                                        <table id="dataTable" class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Customer</th>
                                                    <th>Phone</th>
                                                    <th>Project</th>
                                                    <th>Employee</th>
                                                    <th>Area</th>

                                                    <th>Net Amount</th>
                                                    <th>Paid Amount</th>
                                                    <th>Status</th>
                                                    <th>Release</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Your table content -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <ul id="pagination" class="pagination"></ul>
                                </div>
                            </div>
                        </div>



                    </div>
                </div>
                <!-- content-wrapper ends -->
                <div id="includeFooder"></div>
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- plugins:js -->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <!--  -->

    <!-- Your custom JavaScript code here -->
    <div id="customAlertModal" class="custom-modal" style="display:none;">
        <div class="custom-modal-content">
          <p id="alertMessage"></p>
          <div class="modal-buttons">
            <button id="alertYesButton">Yes</button>
            <button id="alertNoButton">No</button>
          </div>
        </div>
      </div>
  
    <div class="container-fluid page-body-wrapper">
        <div id="includeHtml"></div>


        <script>

function logout() {
    // Clear local storage
    localStorage.clear();

    // Replace current state with a new state to prevent going back
    window.history.replaceState(null, "", window.location.href);

    // Add an event listener to handle the popstate event
    window.onpopstate = function (event) {
        // Push another state to forward the user
        window.history.pushState(null, "", window.location.href);
    };

    // Redirect to the logout page or perform other logout actions
    window.location.href = '../../index.html';
   }
            let isContentLoaded = false;

            document.addEventListener('DOMContentLoaded', async function () {
                if (isContentLoaded) return; // Prevent multiple executions
                isContentLoaded = true;

                try {
                    const accessToken = localStorage.getItem('accessToken');
                    const employeeEmail = localStorage.getItem('employeeEmail');
                    // Fetch employee details to get associated company ID
                    const responseEmployee = await fetch('http://localhost:8080/api/employee/getEmployeeByEmail/' + employeeEmail, {
                        method: 'GET',
                        headers: {
                            'Authorization': accessToken
                        },
                    });

                    if (!responseEmployee.ok) {
                        throw new Error('Failed to fetch employee details');
                    }

                    const dataEmployee = await responseEmployee.json();

                    // Ensure that the company object and companyId are properly fetched
                    if (!dataEmployee.company || !dataEmployee.company.companyId) {
                        throw new Error('Company ID not found in employee details');
                    }

                    const companyId = dataEmployee.company.companyId;

                    // Check if the current URL already contains the company ID parameter
                    if (!window.location.href.includes(`companyId=${companyId}`)) {
                        // Redirect to the Customer List page with company ID query parameter
                        const formUrl = `block_list.html?companyId=${companyId}`;
                        window.location.href = formUrl;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    // Handle error
                }
            });


            function closeForm() {
                // Assuming 'employeeModal' is the ID of your modal

                $('#companyModal').modal('hide');
            }
            var formData = new FormData();

            function AlertMessageForReleaseConfirm(message, callback) {
  // Display the custom modal
  document.getElementById('customAlertModal').style.display = 'flex';
  document.getElementById('alertMessage').innerText = message;

  // Handle Yes button click
  document.getElementById('alertYesButton').onclick = function () {
    document.getElementById('customAlertModal').style.display = 'none';
    callback(true); // Execute callback with true for Yes
  };

  // Handle No button click
  document.getElementById('alertNoButton').onclick = function () {
    document.getElementById('customAlertModal').style.display = 'none';
    callback(false); // Execute callback with false for No
  };
}

            jQuery(document).ready(async function ($) {
                $(document).on('click','.edit-btn', function () {
                    
                    var blockId = $(this).data('blocks-id');
                    AlertMessageForReleaseConfirm("Are you sure to release the block?", function (confirmed) {
    if (confirmed) {
                        const accessToken = localStorage.getItem('accessToken');

                        $.ajax({
                            url: 'http://localhost:8080/api/blocks/getBlocksById/' + blockId,
                            type: 'GET',
                            headers: {

                                'Authorization': accessToken
                            },
                            success: function (response) {

                                var manuallyReleasedblockData = response;

                                // if i have block data then i need to do 3 functions below(1.post in blockRelesed table 2.change block status in site visit page 3.delete in block table)
                                $.ajax({
                                    url: 'http://localhost:8080/api/blockReleasedManually/addBlocksReleased',
                                    type: 'POST',

                                    data: JSON.stringify(manuallyReleasedblockData), // Use data obtained from the GET request
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': accessToken
                                    },
                                    success: async function (response) {

                                        console.log("Successfully added in manual release table");


                                        const findByVisitIdAndProjectNameResponse = await fetch(`http://localhost:8080/api/visit/getByVisitDetailIdAndProjectNameForBlockRelease/${blockData.visitId}/${blockData.projectName}`,
                                        {
                                            method: 'PUT',
                                            headers: {
                                                'Authorization': accessToken
                                            },
                                            credentials: 'include'
                                        });

                                    if (!findByVisitIdAndProjectNameResponse.ok) {
                                        throw new Error('Failed to fetch Visit Details');
                                    }
                                    console.log("good", findByVisitIdAndProjectNameResponse);
                                    const visitDetails = await findByVisitIdAndProjectNameResponse.json();
                                    console.log('Visit Details:', visitDetails);

                                        // Handle success
                                    },
                                    error: function (xhr, status, error) {
                            console.error(xhr.responseText); // Log the error response
                            console.error(error); // Log the error message
                             showalert('Release Failed to add in release Table!!'); // Display an error message to the user
                        }
                                });
                            },
                            error: function (xhr, status, error) {
                                // Handle error console.error(xhr.responseText); // Log the error response
                            console.error(error); // Log the error message
                             showalert('Release Failed to add in release Table!!'); // Display an error message to the user
                      

                            }
                        });
                        const accessTokens = localStorage.getItem('accessToken');
                        console.log('accessToken:', accessTokens);
                        // Second function: @DeleteMapping("/deleteBlockById/{blockId}")
                        $.ajax({
                            url: 'http://localhost:8080/api/blocks/deleteBlockById/' + blockId, // Assuming visitId is the blockId
                            type: 'DELETE',
                            contentType: 'application/json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessTokens
                            },
                            success: function (response) {
                            
                                showalert('Released Successfully', function()
                            {
                                window.location.reload();
                            });
                               
                                // Handle success
                            },
                            error: function (xhr, status, error) {
                            console.error(xhr.responseText); // Log the error response
                            console.error(error); // Log the error message
                             showalert('Release Failed!!'); // Display an error message to the user
                        }
                        });
                    }
                });
            });



                async function releaseBlock(blockIdForAutoRelease) {
                    var blockId = blockIdForAutoRelease;

                    // First function: @PostMapping("/addBlocksReleased")
                    const accessToken = localStorage.getItem('accessToken');
                    $.ajax({
                        url: 'http://localhost:8080/api/blocks/getBlocksById/' + blockId,
                        type: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': accessToken,
                        },
                        success: function (response) {
                            // Handle success
                            var blockreleasedData = response;
                            // Second function: @PostMapping("/addBlocksReleased")
                            $.ajax({
                                url: 'http://localhost:8080/api/blockReleasedAutomatically/addBlocksReleasedAutometically',
                                type: 'POST',

                                data: JSON.stringify(blockreleasedData),
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': accessToken
                                },
                                success: async function (response) {

                                    //releasing the block in site visit list
                                    const findByVisitIdAndProjectNameResponse = await fetch(`http://localhost:8080/api/visit/getByVisitDetailIdAndProjectNameForBlockRelease/${blockreleasedData.visitId}/${blockreleasedData.projectName}`,
                                        {
                                            method: 'PUT',
                                            headers: {
                                                'Authorization': accessToken
                                            },
                                            credentials: 'include'
                                        });

                                    if (!findByVisitIdAndProjectNameResponse.ok) {
                                        throw new Error('Failed to fetch Visit Details');
                                    }
                                    console.log("good", findByVisitIdAndProjectNameResponse);
                                    const visitDetails = await findByVisitIdAndProjectNameResponse.json();
                                    console.log('Visit Details:', visitDetails);

                                    // Handle success
                                },
                                error: function (xhr, status, error) {
                                    // Handle error
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            // Handle error
                        }
                    });

                    // Second function: @DeleteMapping("/deleteBlockById/{blockId}")
                    $.ajax({
                        url: 'http://localhost:8080/api/blocks/deleteBlockById/' + blockId,
                        type: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': accessToken,
                        },
                        success: function (response) {
                            window.location.reload();
                            // Handle success
                        },
                        error: function (xhr, status, error) {
                            // Handle error
                        }
                    });
                }
                $('#filterButton').click(function () {
                    $('#filterFields').toggle();
                });
                function redirectToBlockPage(visitDetailId) {
                    // Construct the URL with the visitDetailId parameter
                    const url = `block_details.html?id=${visitDetailId}`;
                    // Redirect to the new URL
                    window.location.href = url;
                }
                $(document).on('click', '.block-btn', function () {

                    var visiterId = $(this).data('company-id');
                    var phoneNo = $(this).data('phone-number');

                    window.location.href = `block_details.html?id=${visiterId}&phoneNumber=${phoneNo}`;
                });

                $(document).on('click', '.book-btn', function () {

                    var visiterId = $(this).data('company-id');
                    var phoneNo = $(this).data('phone-number');
                    var project = $(this).data('project-name');
                    console.log(phoneNo, project);
                    window.location.href = `booking_details.html?id=${visiterId}&phoneNumber=${phoneNo}&projectName=${project}`;
                });



                var accumulatedData = [];


                function fetchVisitDetails(mobile, startDate, endDate, employeeNames, customerNames, statusFilter, buyingDurationFilter, fundingResourceFilter) {
                    // Fetch data by date range
                    accumulatedData = [];
                    var requests = [];


                    if (startDate && endDate) {
                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByDateRange?startDate=${startDate}&endDate=${endDate}`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            success: function (dateRangeData) {
                                console.log("1");
                                accumulateData(dateRangeData);

                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for date range data
                            }
                        }));
                    }
                    // Fetch data by date range
                    if (mobile) {

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: 'http://localhost:8080/api/visit/getByPhoneNumbers',
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            data: { phoneNumber: mobile },
                            success: function (phoneNumberData) {
                                console.log("hi");
                                accumulateData(phoneNumberData);


                            },
                            error: function (xhr, status, error) {
                                console.error('Error in getByPhoneNumbers AJAX request:');
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data
                            }
                        }));
                    }
                    if (employeeNames) {
                        // Fetch data by date range

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByEmployeeNames`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            data: { employeeName: employeeNames },
                            success: function (employeedata) {
                                console.log("3");

                                accumulateData(employeedata);

                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data
                            }
                        }));
                    }
                    if (customerNames) {

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByCustomerNames`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            data: { customerName: customerNames },
                            success: function (customerdata) {
                                accumulateData(customerdata);
                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data
                            }
                        }));
                    }
                    if (statusFilter) {

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByStatus`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },

                            data: { status: statusFilter },
                            success: function (statusData) {
                                accumulateData(statusData);
                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data
                            }
                        }));
                    }
                    if (buyingDurationFilter) {

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByBuyingDurations`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            data: { buyingDuration: buyingDurationFilter },
                            success: function (buyingDurationData) {
                                accumulateData(buyingDurationData);
                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data   
                            }
                        }));
                    }
                    if (fundingResourceFilter) {

                        const accessToken = localStorage.getItem('accessToken');
                        requests.push($.ajax({
                            url: `http://localhost:8080/api/visit/getByFundingSources`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': accessToken,
                            },
                            data: { fundingSource: fundingResourceFilter },
                            success: function (fundingResourceData) {
                                accumulateData(fundingResourceData);
                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                                console.error(error);
                                // Handle error for phone number data
                            }
                        }));

                    }
                    $.when.apply($, requests).then(function () {
                        // Collect data from all responses
                        $.each(arguments, function (index, responseData) {
                            accumulateData(responseData[0]);
                        });
                        // Apply filters after all AJAX requests have completed
                        applyFilters();
                    });
                    function accumulateData(data) {
                        // Combine the new data with the accumulated data
                        accumulatedData = accumulatedData.concat(data);

                        // Apply filters to the accumulated data

                    }
                    function applyFilters() {
                        // Apply filters to the accumulated data and update the table
                        var filteredData = accumulatedData;
                        var encounteredPhoneNumbers = new Set();
                        console.log("Accumulated data:", accumulatedData);
                        console.log("Filtered data before filtering:", filteredData);


                        var filteredData = accumulatedData.filter(item => typeof item === 'object');

                        if (filteredData && filteredData.length > 0) {
                            if (mobile && filteredData.length > 0) {
                                var mobileNumbers = mobile.split(',');
                                filteredData = filteredData.filter(item =>
                                    mobileNumbers.includes(item.phoneNumber)
                                );

                                console.log("shanuuu");
                            }
                            if (startDate && endDate && filteredData.length > 0) {
                                filteredData = filteredData.filter(item => {
                                    const visitDate = new Date(item.date);
                                    return visitDate >= new Date(startDate) && visitDate <= new Date(endDate);
                                });
                            }

                            // Filter by employee names
                            if (employeeNames && filteredData.length > 0) {
                                filteredData = filteredData.filter((item, index, self) =>
                                    index === self.findIndex(t => t.visitDetailId === item.visitDetailId) &&
                                    item.employeeName === employeeNames
                                );
                            }

                            // Filter by customer names
                            if (customerNames && filteredData.length > 0) {
                                filteredData = filteredData.filter((item, index, self) =>
                                    index === self.findIndex(t => t.visitDetailId === item.visitDetailId) &&
                                    item.customerName === customerNames
                                );
                            }

                            // Filter by status
                            if (statusFilter && filteredData.length > 0) {
                                filteredData = filteredData.filter((item, index, self) =>
                                    index === self.findIndex(t => t.visitDetailId === item.visitDetailId) &&
                                    item.status === statusFilter);
                            }

                            // Filter by buying duration
                            if (buyingDurationFilter && filteredData.length > 0) {
                                filteredData = filteredData.filter((item, index, self) =>
                                    index === self.findIndex(t => t.visitDetailId === item.visitDetailId) &&
                                    item.buyingDuration === buyingDurationFilter);
                            }

                            // Filter by funding resource
                            if (fundingResourceFilter && filteredData.length > 0) {
                                filteredData = filteredData.filter((item, index, self) =>
                                    index === self.findIndex(t => t.visitDetailId === item.visitDetailId) &&
                                    item.fundingSource === fundingResourceFilter);
                            }
                            console.log("Filtered data after filtering:", filteredData);
                            var data = [];

                            var uniqueVisitDetailIds = new Set();
                            filteredData = filteredData.filter(item => {
                                // Check if the current visitDetailId has already been encountered
                                if (uniqueVisitDetailIds.has(item.visitDetailId)) {
                                    // If the visitDetailId is already in the set, return false to exclude it from the filtered data
                                    return false;
                                } else {
                                    // If the visitDetailId is not in the set, add it to the set and return true to include it in the filtered data
                                    uniqueVisitDetailIds.add(item.visitDetailId);
                                    data.push(item);
                                    return true;
                                }
                            });



                            // Update the table with the filtered data
                            updateTable(data);



                        }
                    }
                    function updateTable(updatedData) {

                        // Clear existing table rows
                        var tableBody = $('#dataTable tbody');
                        tableBody.empty();
                        let blockStatus = 'Permanent';
                        // Populate table with fetched data

                        // Iterate through projectNames and create a new row for each project name
                        updatedData.forEach(details => {
                            const twentyFourHoursAgo = new Date().getTime() - 24 * 60 * 60 * 1000;
                            let blockStatus = '';

                            if (details.paidAmount > 0) {
                                blockStatus = 'Permanent'; // Set isBlocked to true if payment is greater than 0 or time is less than 24 hours
                            } else {
                                const blockedDate = new Date(details.paidDate);
                                const currentDate = new Date();

                                // Calculate the time difference in milliseconds
                                const timeDifference = currentDate.getTime() - blockedDate.getTime();

                                // Check if the time difference exceeds 24 hours
                                if (timeDifference >= 24 * 60 * 60 * 1000) {
                                    releaseBlock(details.blockId); // Release block if more than 24 hours have passed
                                } else {
                                    // Calculate remaining time
                                    const remainingTime = twentyFourHoursAgo - blockedDate.getTime();

                                    const remainingTimeDate = new Date(remainingTime);
                                    const hours = ('0' + remainingTimeDate.getUTCHours()).slice(-2); // Ensures two digits with leading zero
                                    const minutes = ('0' + remainingTimeDate.getUTCMinutes()).slice(-2); // Ensures two digits with leading zero
                                    const seconds = ('0' + remainingTimeDate.getUTCSeconds()).slice(-2); // Ensures two digits with leading zero
                                    blockStatus = `${hours}:${minutes}:${seconds} left`;
                                    console.log(`Time Difference: ${hours}:${minutes}:${seconds} left`);
                                }
                            }

                            $('#dataTable tbody').append(`
                    <tr>          
                    <td>${new Date(details.paidDate).toLocaleDateString()}</td>
                    <td>${details.customerName}</td>
                        <td>${details.mobileNumber}</td>        
                        <td>${details.projectName}</td>
                        <td>${details.blockEmpName}</td>
                        <td>${details.plotNumber}</td>
                        <td>${details.netAmount}</td>
                        <td>${details.paidAmount}</td>
                        <td>${blockStatus}</td>
                         
                    <td>
                        <button type="button" class="btn btn-info btn-sm edit-btn" data-toggle="modal" data-target="#visitDetailModal" data-blocksId-id="${details.blocksId}">Release</button>
                        </td>
                    
                </tr>
            `);
                        });


                        $('#companyModal').modal('hide');
                    }
                }

                $('#search-button').on('click', function () {
                    var mobile = $('#mobile').val(); // Get the mobile number
                    var fromDate = $('#fromDate').val();
                    var toDate = $('#toDate').val();
                    var employeeNames = $('#filterEmployeeNames').val();
                    var customerNames = $('#filtercustomerNames').val();
                    // var filterProjectName = $('#filterProjectName').val();
                    // Validate the input if needed
                    fetchVisitDetails(mobile, fromDate, toDate, employeeNames, customerNames);
                });


                function populateVisitDetails() {
                    const MainMenus = localStorage.getItem('MainMenus');
                    const urlParams = new URLSearchParams(window.location.search);
            const companyId = parseInt(urlParams.get('companyId')); // Parse companyId to integer
            const teamIdFromLocalStorage = localStorage.getItem('teamId');
            const canRelease = MainMenus && MainMenus.includes('BlockedList Release');
          
    // Parse teamIdFromLocalStorage into an array if it's not null
           const teamIds = teamIdFromLocalStorage ? teamIdFromLocalStorage.split(',').map(id => parseInt(id)) : [];
         
                    const accessToken = localStorage.getItem('accessToken');
                    if (MainMenus && MainMenus.includes('Employee Form')) { 

                    $.ajax({
                        url: 'http://localhost:8080/api/blocks/getBlocksByCompanyId/'+companyId,
                        type: 'GET',
                        dataType: 'json',
                        headers: {

                            'Authorization': accessToken,
                        },
                        success: function (blockData) {
                            $('#dataTable tbody').empty();
                            // Populate table with fetched data

                            const urlParams = new URLSearchParams(window.location.search);
                               let blockStatus = 'Permanent';
                            // Iterate over visit details
                            blockData.forEach(blockEntry => {
                                // Check if the visit is blocked
                                // Initialize isBlocked to false
                                const fortyEightHoursAgo = new Date().getTime() - 48 * 60 * 60 * 1000;

                                let blockStatus = '';

                                if (blockEntry.paidAmount > 0) {
                                    blockStatus = 'Permanent'; // Set isBlocked to true if payment is greater than 0 or time is less than 48 hours
                                } else {
                                    const blockedDate = new Date(blockEntry.paidDate);
                                    const currentDate = new Date();

                                    // Calculate the time difference in milliseconds
                                    const timeDifference = currentDate.getTime() - blockedDate.getTime();

                                    // Check if the time difference exceeds 48 hours
                                    if (timeDifference >= 48 * 60 * 60 * 1000) {
                                        console.log(blockEntry.blocksId);
                                        releaseBlock(blockEntry.blocksId); // Release block if more than 48 hours have passed
                                    } else {
                                        // Calculate remaining time from current time
                                        const remainingTime = blockedDate.getTime() + (48 * 60 * 60 * 1000) - currentDate.getTime();

                                        // If remaining time is negative, set it to 0
                                        const timeLeft = Math.max(0, remainingTime);

                                        const remainingTimeDate = new Date(timeLeft);
                                        const hours = ('0' + Math.floor(timeLeft / (1000 * 60 * 60))).slice(-2);
                                        const minutes = ('0' + Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60))).slice(-2);
                                        const seconds = ('0' + Math.floor((timeLeft % (1000 * 60)) / 1000)).slice(-2);
                                        blockStatus = `${hours}:${minutes}:${seconds}  `;
                                        console.log(`Time Difference: ${hours}:${minutes}:${seconds} `);
                                    }
                                }
                                let buttons = '';
                                if (canRelease) {
                buttons += `
                    <button type="button" class="btn btn-info btn-sm edit-btn" data-toggle="modal"
                        data-target="#visitDetailModal" data-blocks-id="${blockEntry.blocksId}">Release</button>
                `;
            }
                                $(`#blockStatus_${blockEntry.blocksId}`).text(blockStatus);

                                $('#dataTable tbody').append(`
                    <tr>       
                        <td>${new Date(blockEntry.paidDate).toLocaleDateString()}</td>
                        <td>${blockEntry.customerName}</td>
                        <td>${blockEntry.mobileNumber}</td>        
                        <td>${blockEntry.projectName}</td>
                        <td>${blockEntry.blockEmpName}</td>
                        <td>${blockEntry.plotNumber}</td>
                        <td>${blockEntry.netAmount}</td>
                        <td>${blockEntry.blocksId}</td>
                        <td>${blockStatus}</td>
                        <td>
                          ${buttons}      
                        </td>

                    </tr>
                `);

                            });
                        },
                        error: function (xhr, status, error) {
                            console.error(xhr.responseText); // Log the error response
                            console.error(error); // Log the error message
                            // showalert('Error fetching data from the server. Please try again later.'); // Display an error message to the user
                        }
                    });
                }
                else
{
    $.ajax({
    url: `http://localhost:8080/api/blocks/companyAndTeamId/${companyId}/${teamIdFromLocalStorage}`,
    type: 'GET',
    dataType: 'json',
    headers: {
        'Authorization': accessToken,
    },
    success: function (blockData) {
        $('#dataTable tbody').empty();
        console.log('Data fetched successfully:', blockData);
        
        blockData.forEach(blockEntry => {
            const fortyEightHoursAgo = new Date().getTime() - 48 * 60 * 60 * 1000;
            let blockStatus = '';

            if (blockEntry.paidAmount > 0) {
                blockStatus = 'Permanent';
            } else {
                const blockedDate = new Date(blockEntry.paidDate);
                const currentDate = new Date();
                const timeDifference = currentDate.getTime() - blockedDate.getTime();

                if (timeDifference >= 48 * 60 * 60 * 1000) {
                    console.log(blockEntry.blocksId);
                    releaseBlock(blockEntry.blocksId);
                } else {
                    const remainingTime = blockedDate.getTime() + (48 * 60 * 60 * 1000) - currentDate.getTime();
                    const timeLeft = Math.max(0, remainingTime);
                    const hours = ('0' + Math.floor(timeLeft / (1000 * 60 * 60))).slice(-2);
                    const minutes = ('0' + Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60))).slice(-2);
                    const seconds = ('0' + Math.floor((timeLeft % (1000 * 60)) / 1000)).slice(-2);
                    blockStatus = `${hours}:${minutes}:${seconds}`;
                   // console.log(Time Difference: ${hours}:${minutes}:${seconds});
                }
            }

            $(`#blockStatus_${blockEntry.blocksId}`).text(blockStatus);

            $('#dataTable tbody').append(`
                <tr>
                    <td>${new Date(blockEntry.paidDate).toLocaleDateString()}</td>
                    <td>${blockEntry.customerName}</td>
                    <td>${blockEntry.mobileNumber}</td>
                    <td>${blockEntry.projectName}</td>
                    <td>${blockEntry.blockEmpName}</td>
                    <td>${blockEntry.plotNumber}</td>
                    <td>${blockEntry.netAmount}</td>
                    <td>${blockEntry.paidAmount}</td>
                    <td>${blockStatus}</td>
                    <td>
                        <button type="button" class="btn btn-info btn-sm edit-btn" data-toggle="modal" data-target="#visitDetailModal" data-blocksId-id="${blockEntry.blocksId}">Release</button>
                    </td>
                </tr>
            `);
        });
    },
    error: function (xhr, status, error) {
        console.error('AJAX Error:', xhr.responseText);
        console.error('Status:', status);
        console.error('Error:', error);
    }
});
}
                }
                // Call the function to populate visit details when the page loads
                $(document).ready(function () {
                    populateVisitDetails();
                    setInterval(populateVisitDetails, 1000);
                });

                var currentCompanyId;

                $(document).on('click', '.view-btn', function () {
                    currentCompanyId = $(this).data('company-id');
                    var visitId = $(this).data('company-id');
                    const accessToken = localStorage.getItem('accessToken');
                    $.ajax({
                        url: 'http://localhost:8080/api/visit/getVisitDetailsById/' + visitId,
                        type: 'GET',
                        dataType: 'json',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': accessToken,
                        },
                        success: function (visitData) {
                            console.log(visitData);

                            document.body.scrollTop = 0; // For Safari
                            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE, and Opera

                            $('#companyModal').modal('show');

                        },
                        error: function (xhr, status, error) {
                            console.error(xhr.responseText);
                            console.error(error);
                            //   showalert('Error fetching company details. Please try again later.');
                        }
                    });

                });




                $(document).ready(function () {
                    $('#mobileNumber').on('input', function () {
                        var mobileNumber = $(this).val();

                        // Check if the input contains letters
                        if (/[a-zA-Z]/.test(mobileNumber)) {
                            showalert('Please enter digits only.');
                            mobileNumber = mobileNumber.replace(/[a-zA-Z]/g, '');
                        }

                        // Remove any non-digit characters
                        mobileNumber = mobileNumber.replace(/\D/g, '');

                        // Limit to 12 digits
                        if (mobileNumber.length > 12) {
                            showalert('Please enter a maximum of 12 digits.');
                            mobileNumber = mobileNumber.substr(0, 12);
                        }

                        $(this).val(mobileNumber);
                    });
                });

                $(document).ready(function () {
                    $('#phoneNumber').on('input', function () {
                        var phoneNumber = $(this).val();

                        // Check if the input contains letters
                        if (/[a-zA-Z]/.test(phoneNumber)) {
                            showalert('Please enter digits only.');
                            phoneNumber = phoneNumber.replace(/[a-zA-Z]/g, '');
                        }

                        // Remove any non-digit characters
                        phoneNumber = phoneNumber.replace(/\D/g, '');

                        // Limit to 12 digits
                        if (phoneNumber.length > 12) {
                            showalert('Please enter a maximum of 12 digits.');
                            phoneNumber = phoneNumber.substr(0, 12);
                        }

                        $(this).val(phoneNumber);
                    });
                });

                $(document).ready(function () {
                    $('#customerName, #customerName1,#city,#district,#state').on('input', function () {
                        var inputValue = $(this).val();
                        // Check if the input contains any numeric characters
                        if (/\d/.test(inputValue)) {
                            showalert('Please enter alphabetic characters only.');
                            // Remove the numeric characters
                            $(this).val(inputValue.replace(/\d/g, ''));
                        }
                        if (inputValue.length > 50) {
                            showalert('Maximum length exceeded. Please enter up to 50 characters.');
                            // Trim the input to the maximum length
                            $(this).val(inputValue.slice(0, 50));
                        }
                    });
                });



                $(document).ready(function () {
                    $('#driver').on('input', function () {
                        var inputValue = $(this).val();
                        // Check if the input contains any numeric characters
                        if (/\d/.test(inputValue)) {
                            showalert('Please enter alphabetic characters only.');
                            // Remove the numeric characters
                            $(this).val(inputValue.replace(/\d/g, ''));
                        }

                        if (inputValue.length > 50) {
                            showalert('Maximum length exceeded. Please enter up to 50 characters.');
                            // Trim the input to the maximum length
                            $(this).val(inputValue.slice(0, 50));
                        }
                    });
                });

                $(document).ready(function () {
                    $('#startingKms,#endKms').on('input', function () {
                        var startingKms = $(this).val();
                        // Check if input contains any non-numeric or non-decimal characters
                        if (/[^0-9.]/.test(startingKms)) {
                            showalert('Please enter numbers only.');
                            // Remove non-numeric and non-decimal characters
                            startingKms = startingKms.replace(/[^0-9.]/g, '');
                            $(this).val(startingKms);
                        }


                    });
                });

                $(document).ready(function () {
                    $('#postalCode').on('input', function () {
                        var postalCode = $(this).val();
                        // Check if input contains non-numeric characters or more than 6 digits
                        if (/\D/.test(postalCode) || postalCode.length > 6) {
                            showalert('Please enter exactly 6 digits.');
                            // Remove non-numeric characters and extra digits
                            postalCode = postalCode.replace(/\D/g, '').substr(0, 6);
                            $(this).val(postalCode);
                        }
                    });
                });


                $(document).ready(function () {
                    $('#location,#address,streetName,employeeType,#workPlace,#area,#vehicleType').on('input', function () {
                        var inputValue = $(this).val();
                        // Check if the input contains any numeric characters


                        // Check if the input length exceeds the limit
                        if (inputValue.length > 100) {
                            showalert('Maximum length exceeded. Please enter up to 50 characters.');
                            // Trim the input to the maximum length
                            $(this).val(inputValue.slice(0, 100));

                        }
                    });
                });

                $(document).ready(function () {
                    $('#photo').on('change', function (event) {
                        var input = event.target;
                        if (input.files && input.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                var image = new Image();
                                image.src = e.target.result;
                                image.onload = function () {
                                    if (!input.files[0].type.match('image/jpeg')) {
                                        showalert('Please select a JPG image.');
                                        input.value = ''; // Clear the input
                                    }
                                };
                                image.onerror = function () {
                                    showalert('Please select a IMG/JPG formatted image.');
                                    input.value = '';
                                };
                            };
                            reader.readAsDataURL(input.files[0]);
                        }
                    });
                });



                // console.log(companyData,'new');
                //console.log('Cab Element:', document.getElementById('cab'));
                //console.log('Driver Element:', document.getElementById('driver'));


            });


        </script>
        <!-- plugins:js -->
      <script src="../../assets/vendors/js/vendor.bundle.base.js"></script></script>
 */
        <!-- endinject -->
        <!-- Plugin js for this page -->
        <script src="../../assets/vendors/chart.js/Chart.min.js"></script>
        <!-- End plugin js for this page -->
        <!-- inject:js -->
        <script src="../../assets/js/off-canvas.js"></script>
        <script src="../../assets/js/hoverable-collapse.js"></script>
        <!-- <script src="../../assets/js/pagination.js"></script> -->
        <script src="../../assets/js/menu_active.js"></script>
      <!--<script src="../../assets/js/misc.js"></script> -->
        <!-- endinject -->
        <!-- Custom js for this page -->
        <script src="../../assets/js/chart.js"></script>
        <!-- End custom js for this page -->
</body>

</html>
