<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Confirmed Form | Aishalaya</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="http://127.0.0.1:5500/assets/css/style.css">
 
  <!-- End layout styles -->
  <link rel="shortcut icon" href="../../assets/images/aishLogo.ico" />
  <!--showalert Message-->
  <script src="http://127.0.0.1:5500/assets/js/alertMessages.js"></script>
 
   
</head>

<body>
  <div class="container-scroller">

    <!-- partial:../../partials/_navbar.html -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
        <a class="navbar-brand brand-logo" href="/pages/dashboard/dashboard.html"><img
            src="../../assets/images/logo.png" alt="logo" style="height: 100%;" /></a>
        <a class="navbar-brand brand-logo-mini" href="/pages/dashboard/dashboard.html"><img
            src="../../assets/images/logo.png" alt="logo" style="height: 100%;" /></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="mdi mdi-menu"></span>
        </button>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item d-none d-lg-block full-screen-link">
            <a class="nav-link">
              <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
            </a>
          </li>
          <li class="nav-item nav-logout d-none d-lg-block">
            <a class="nav-link" onclick="logout()">
              <i class="mdi mdi-power"></i>
            </a>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
          data-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:../../partials/_sidebar.html -->
      <div id="includeHtml"></div>

      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">Confirmed Form </h3>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/pages/dashboard/dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Confirmed Form</li>
              </ol>
            </nav>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <!-- <h4 class="card-title">Project</h4> -->
                  <form class="form-sample" id="plotConfirmingForm">

                    <div class="accordion accordion-flush" id="accordionFlushExample">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingOne">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                            Customer Infomation
                          </button>
                        </h2>
                        <div id="flush-collapseOne" class="accordion-collapse collapse"
                          aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                          <div class="accordion-body">
                            <div class="row">
                              <table id="customerTable" class="table table-hover">
                                <tbody>
                                  <tr>
                                    <td>Customer Code:</td>
                                    <td id="customerCode"></td>
                                  </tr>
                                  <tr>
                                    <td>Mobile Number:</td>
                                    <td id="mobileNumber"></td>
                                  </tr>
                                  <tr>
                                    <td>Preferred Location:</td>
                                    <td id="location"></td>
                                  </tr>
                                  <!-- <tr>
                                          <td>Preferred Budget:</td>
                                          <td id="preferredBudget"></td>
                                      </tr> -->
                                  <tr>
                                    <td>Email:</td>
                                    <td id="email"></td>
                                  </tr>

                                  <tr>
                                    <td>Employee Type:</td>
                                    <td id="employeeType"></td>
                                  </tr>
                                  <tr>
                                    <td>Work Place:</td>
                                    <td id="workPlace"></td>
                                  </tr>
                                  <tr>
                                    <td>Address:</td>
                                    <td id="address"></td>
                                  </tr>
                                </tbody>
                              </table>

                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingThree">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseThree" aria-expanded="false"
                            aria-controls="flush-collapseThree">
                            Plots Infomation
                          </button>
                        </h2>
                        <div id="flush-collapseThree" class="accordion-collapse collapse"
                          aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="container mt-5">
                                <div class="table-responsive">
                                  <table class="table table-bordered" id="dataTable">
                                    <thead>
                                      <tr>
                                        <th>Project</th>
                                        <th>Plot No </th>
                                        <th>Total SQFT</th>
                                        <th>Rate Per SQFT</th>
                                        <th>Total Values</th>
                                        <!-- <th>Description</th> -->
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr>
                                        <td>
                                          <input type="text" class="form-control" id="projectName" name="projectName"
                                            readonly>

                                          </select>
                                        </td>
                                        <td> <input id="plotNumber" name="plotNumber" class="form-control" readonly>

                                        </td>


                                        <td><input type="text" class="form-control" id="totalsqrt" name="totalsqrt"
                                            readonly placeholder="Total sqrt"></td>
                                        <td><input type="text" class="form-control" id="rate" name="rate" readonly
                                            placeholder="rate"></td>
                                        <td><input type="text" class="form-control" id="totalValues" name="totalValues"
                                            readonly placeholder="total values" readonly></td>
                                        <!-- <td><input type="text" class="form-control" id="description" name="description"
                                            readonly placeholder="description"></td> -->
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>


                      <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingsix">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapsesix" aria-expanded="false" aria-controls="flush-collapsesix">
                            Document Infomation <span class="text-danger">*</span>
                          </button>
                        </h2>
                        <div id="flush-collapsesix" class="accordion-collapse collapse"
                          aria-labelledby="flush-headingsix" data-bs-parent="#accordionFlushExample">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="agreementDocumentSNo">Agreement Document
                                    Serial No</label>
                                  <div class="col-sm-9">
                                    <input type="text" id="agreementDocumentSNo" name="agreementDocumentSNo"
                                      class="form-control" placeholder="Serial Number" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="agreementDocuments">Agreement
                                    Documents</label>
                                  <div class="col-sm-9">
                                    <input class="form-control" type="file" id="agreementDocuments"
                                      name="agreementDocuments" placeholder="Serial Number" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="idDocumentSNo">Id Document Serial
                                    No</label>
                                  <div class="col-sm-9">
                                    <input type="text" id="idDocumentSNo" name="idDocumentSNo" class="form-control"
                                      placeholder="Serial Number" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="idProofDocument">Id Documents</label>
                                  <div class="col-sm-9">
                                    <input class="form-control" type="file" id="idProofDocument" name="idProofDocument"
                                      placeholder="Enter Draft Documents" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="legalDocumentSNo">Legal Document Serial
                                    No</label>
                                  <div class="col-sm-9">
                                    <input type="text" id="legalDocumentSNo" name="legalDocumentSNo"
                                      class="form-control" placeholder="Enter LegalDetails" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                  <label class="col-sm-6 col-form-label" for="legalDocuments">Legal Documents</label>
                                  <div class="col-sm-9">
                                    <input class="form-control" type="file" id="legalDocuments" name="legalDocuments" />
                                  </div>
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="d-flex justify-content-end">
                      <button type="submit" class="btn btn-gradient-primary me-2" id="submitBtn">Submit</button>
                      <a href="project_list.html" class="btn btn-light">Cancel</a>
                    </div>

                  </form>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <div id="includeFooder"></div>
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <script src="../../assets/js/project_form.js"></script>
  <!-- plugins:js -->
<script src="../../assets/vendors/js/vendor.bundle.base.js"></script></script>
 */
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <script src="../../assets/vendors/chart.js/Chart.min.js"></script>
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="../../assets/js/off-canvas.js"></script>
  <script src="../../assets/js/hoverable-collapse.js"></script>
  <!-- <script src="../../assets/js/pagination.js"></script> -->
  <script src="../../assets/js/menu_active.js"></script>
  <script src="../../assets/js/misc.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <script src="../../assets/js/chart.js"></script>
  <!-- End custom js for this page -->
  <script>
function logout() {
    // Clear local storage
    localStorage.clear();

    // Replace current state with a new state to prevent going back
    window.history.replaceState(null, "", window.location.href);

    // Add an event listener to handle the popstate event
    window.onpopstate = function (event) {
        // Push another state to forward the user
        window.history.pushState(null, "", window.location.href);
    };

    // Redirect to the logout page or perform other logout actions
    window.location.href = '../../index.html';
   }
    $(document).ready(function () {
      //newly added


      const urlParams = new URLSearchParams(window.location.search);

      const phoneNumber = urlParams.get('phoneNumber');
      const currentBookingId = urlParams.get('id');
      const currentProjectName = urlParams.get('projectName');
      let plotConfirmingEmployeeEmailId = localStorage.getItem('employeeEmail');
      let bookId;

      //displaying the fetched values in the form
      const accessToken = localStorage.getItem('accessToken');
      $.ajax({
        url: `http://localhost:8080/api/customer/getCustomerByPhoneNumber/${phoneNumber}`,
        type: 'GET',
        dataType: 'json',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': accessToken,
        },
        success: function (data) {
          console.log("Customer datas:", data);
          const customerCode = data.customCode;
          const mobileNumberValue = data.mobileNumber;
          const locationValue = data.location;
          const emailValue = data.customerEmail;
          const employeeTypeValue = data.employeeType;
          const workPlaceValue = data.workPlace;
          const addressValue = data.address;

          $('#customerCode').text(customerCode);
          $('#mobileNumber').text(mobileNumberValue);
          $('#location').text(locationValue);
          $('#email').text(emailValue);
          $('#employeeType').text(employeeTypeValue);
          $('#workPlace').text(workPlaceValue);
          $('#address').text(addressValue);
          //plotNumber = data.plotNumber;

          //   console.log("visitId:",visitId);

          //    console.log(projectId,plotNumber);
          // document.getElementById('plotNumber').value = PlotNumberValue;
          // document.getElementById('customername').value = customerNames;
          //   blockDatas(visitId);


        },
      });

      $.ajax({
        url: `http://localhost:8080/api/booking/getBookingDetailsById/${currentBookingId}`,
        type: 'GET',
        dataType: 'json',
        headers: {
          'Authorization': accessToken,
        },
        success: function (data) {
          document.getElementById('projectName').value = data.projectName;
          document.getElementById('plotNumber').value = data.plotNumber;
          document.getElementById('totalsqrt').value = data.totalSqft;
          document.getElementById('rate').value = data.sellingRate;
          document.getElementById('totalValues').value = data.plotTotalAmount;
          // document.getElementById('description').value = data.description;
          bookId = data.bookingId;
          companyId = data.companyId;
          teamId = data.teamId;
          console.log("bookingIds:", companyId);
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText); // Log the error response
          console.error(error); // Log the error message
          showalert('Error fetching data from the server. Please try again later.'); // Display an error message to the user
        }
      });


      document.getElementById('plotConfirmingForm').addEventListener('submit', async function (event) {

        event.preventDefault();
        var currentDate = new Date();
        var formattedDate = currentDate.toISOString();
        const confirmedDate = formattedDate;
        const bookIdValue = bookId;
        const companyIdValue = companyId;
        const teamIdValue = teamId;
        const formData = new FormData();

        const booking = {
          date: confirmedDate,
          bookingId: bookIdValue,
          plotConfirmedEmployeeEmail: plotConfirmingEmployeeEmailId,
          customerCode : document.getElementById('customerCode').innerText,
          mobileNumber: document.getElementById('mobileNumber').innerText,
          email: document.getElementById('email').innerText,
          project: document.getElementById('projectName').value,
          plotNumber: document.getElementById('plotNumber').value,
          totalSqft: document.getElementById('totalsqrt').value,
          ratePerSqft: document.getElementById('rate').value,
          totalValues: document.getElementById('totalValues').value, //
          // description: document.getElementById('description').value,
          legalDocumentSerialNumber: document.getElementById('legalDocumentSNo').value,
          agreementDocumentSerialNumber: document.getElementById('agreementDocumentSNo').value,
          idProofDocumentSerialNumber: document.getElementById('idDocumentSNo').value,
          companyId:companyIdValue,
          teamId:teamIdValue


        };
        console.log("book cancel:", booking);
        formData.append('bookConfirm', new Blob([JSON.stringify(booking)], { type: 'application/json' }));
        // ... (remaining file upload logic)
        const legalFileInput = document.getElementById('legalDocuments');
        if (legalFileInput.files.length > 0) {
          formData.append('legalDocument', legalFileInput.files[0]);
        }
        const agreementFileInput = document.getElementById('agreementDocuments');
        if (agreementFileInput.files.length > 0) {
          formData.append('agreementDocument', agreementFileInput.files[0]);
        }
        const iDFileInput = document.getElementById('idProofDocument');
        if (iDFileInput.files.length > 0) {
          formData.append('idProofDocument', iDFileInput.files[0]);
        }
        console.log("formDate", formData);

        const accessToken = localStorage.getItem('accessToken');

        try {
          const response = await fetch('http://localhost:8080/api/booking/addBookConfirm', {
            method: 'POST',
            body: formData,
            headers: {
              'Authorization': accessToken // Specify the content type as JSON
            },
            // Convert the JavaScript object to JSON string


          });

          if (!response.ok) {

            throw new Error('Failed to confirm the booking');
            showalert('Failed to confirm the Booking');
          }

          showalert('Booking Completed successfully');


          // deleting in booking table, after confirming the plot booking
          $.ajax({
            url: 'http://localhost:8080/api/booking/deleteBookById/' + bookId, // Assuming visitId is the blockId
            type: 'DELETE',

            headers: {
              'Content-Type': 'application/json',
              'Authorization': accessToken
            },
            success: function (response) {
              window.location.reload();
              window.location.href = 'bookingConfirm_list.html';
              // Handle success
            },
            error: function (xhr, status, error) {

              // Handle error
            }
          });
          // Optionally, redirect or perform any other action upon successful submission
        }
        catch (error) {
          console.error('Error:', error);
          showalert('Failed to add Book Details');
        }
      });
    })

  </script>

</body>

</html>