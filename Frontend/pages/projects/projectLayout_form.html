<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Project Layout / Aishalaya</title>
  <link rel="shortcut icon" href="../../assets/images/aishLogo.ico"/>
    
  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="http://127.0.0.1:5500/assets/css/style.css">
 
  <!-- End layout styles -->
  <!--showalert Message-->
  <script src="http://127.0.0.1:5500/assets/js/alertMessages.js"></script>
 
   
  <style>
    #imageContainer {
      width: 100%;
      text-align: center;
      margin-top: 20px;
    }

    #imageContainer img {
      max-width: 100%;
      height: auto;
    }

    @media (max-width: 576px) {
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
    }
  </style>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
  <div class="container-scroller">
      
    <!-- partial:../../partials/_navbar.html -->
    <nav
    class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row"
  >
    <div
      class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center"
    >
    <a class="navbar-brand brand-logo" href="/pages/dashboard/dashboard.html"><img src="../../assets/images/logo.png" alt="logo" style="height: 100%;"/></a>
    <a class="navbar-brand brand-logo-mini" href="/pages/dashboard/dashboard.html"><img src="../../assets/images/logo.png" alt="logo" style="height: 100%;"/></a>
    </div>
    <div class="navbar-menu-wrapper d-flex align-items-stretch">
      <button
        class="navbar-toggler navbar-toggler align-self-center"
        type="button"
        data-toggle="minimize"
      >
        <span class="mdi mdi-menu"></span>
      </button>
      <ul class="navbar-nav navbar-nav-right">
        <li class="nav-item d-none d-lg-block full-screen-link">
          <a class="nav-link">
            <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
          </a>
        </li>
        <li class="nav-item nav-logout d-none d-lg-block">
          <a class="nav-link"  onclick="logout()">
            <i class="mdi mdi-power"></i>
          </a>
        </li>
      </ul>
      <button
        class="navbar-toggler navbar-toggler-right d-lg-none align-self-center"
        type="button"
        data-toggle="offcanvas"
      >
        <span class="mdi mdi-menu"></span>
      </button>
    </div>
  </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:../../partials/_sidebar.html -->
      <div id="includeHtml"></div>

      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title"> Projects Layouts </h3>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../pages/projects/projectLayout_list.html">Project Layout List</a></li>
                <li class="breadcrumb-item active" aria-current="page">Projects Layouts</li>
              </ol>
            </nav>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="card">
                <!-- <div class="card-body"> -->

                <div class="container mt-5">
                  <div class="table-responsive" style="max-height: 400px; overflow-x: auto; overflow-y: auto;">
                    <table class="table table-bordered" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Shape</th>
                                <th>Plot Number</th>
                                <th>Total SQFT</th>
                                <th>Rate Per SQFT</th>
                                <th>Total Values</th>
                                <th>Minimum Selling Rate</th>
                                <th>Description</th>
                                <th style="width: 50%;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select class="form-control" name="shape">
                                        <option value="" disabled selected>Select a Shape</option>
                                        <option value="Poly">Poly</option>
                                        <option value="Rect">Rect</option>
                                        <option value="Circle">Circle</option>
                                    </select>
                                </td>
                                <td><input type="text" class="form-control" name="plotNumber" required/></td>
                                <td><input type="text" class="form-control" name="totalSqft" required/></td>
                                <td><input type="text" class="form-control" name="rate" required/></td>
                                <td><input type="text" class="form-control" name="totalValue" readonly></td>
                                <td><input type="text" class="form-control" name="msp" required/></td>
                                <td><input type="text" class="form-control" name="descrip" required/></td>
                                <td>
                                    <select class="form-control" name="status">
                                        <option value="" disabled selected>Select a Status</option>
                                        <option value="Available Plot">Available Plot</option>
                                        <option value="Freezed Plot">Freezed Plot</option>
                                        <option value="Partially Paid Plot">Partially Paid Plot</option>
                                        <option value="Sold Plot">Sold Plot</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                  <button class="btn btn-primary" id="addRow">Add Row</button>
                  <button class="btn btn-success" id="submitData">Submit Data</button>

                </div>
                <div id="imageContainer">
                  <!-- Image will be displayed here -->
                </div>
              </div>
            </div>
            <!-- </div> -->
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <div id="includeFooder"></div>
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- plugins:js -->
<script src="../../assets/vendors/js/vendor.bundle.base.js"></script></script>
 */
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <script src="../../assets/vendors/chart.js/Chart.min.js"></script>
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="../../assets/js/off-canvas.js"></script>
  <script src="../../assets/js/hoverable-collapse.js"></script>
  <!-- <script src="../../assets/js/pagination.js"></script> -->
  <script src="../../assets/js/menu_active.js"></script>
  <script src="../../assets/js/misc.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <script src="../../assets/js/chart.js"></script>
  <!-- End custom js for this page -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
$(document).ready(function() {
    // Function to get URL parameter by name
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    let currentProjectName= getUrlParameter('projectName');
   
 console.log("current:",currentProjectName);

     // Function to submit form data
function submitFormData() {
    // Function to submit form data
        // Check if the form is valid
        if ($('#dataTable tbody tr:last').find('input[name="plotNumber"]').val() === "" ||
            $('#dataTable tbody tr:last').find('input[name="totalSqft"]').val() === "" ||
            $('#dataTable tbody tr:last').find('input[name="rate"]').val() === "" ||
            $('#dataTable tbody tr:last').find('input[name="msp"]').val() === "" ||
            $('#dataTable tbody tr:last').find('input[name="descrip"]').val() === "" ||
            $('#dataTable tbody tr:last').find('select[name="shape"]').val() === null ||
            $('#dataTable tbody tr:last').find('select[name="status"]').val() === null) {
            showalert('Please fill out all the fields.',function(){
            return; // Exit function if form is not valid
            });
        }

    var newRow = $('#dataTable tbody tr:last'); // Get the last row added
    
    var rowData = {
        projectId: getUrlParameter('projectId'), // Fetch projectId from URL parameters
        plotNumber: newRow.find('input[name="plotNumber"]').val(),
        shape: newRow.find('select[name="shape"]').val(),
        descrip: newRow.find('input[name="descrip"]').val(),
        totalSqft: parseFloat(newRow.find('input[name="totalSqft"]').val()),
        rate: parseFloat(newRow.find('input[name="rate"]').val()),
        totalValue: parseFloat(newRow.find('input[name="totalValue"]').val()),
        msp: parseFloat(newRow.find('input[name="msp"]').val()),
        status: newRow.find('select[name="status"]').val(),
        projectName: currentProjectName,
        teamId:teamId
    };
    
    const accessToken = localStorage.getItem('accessToken');
    // Send the rowData to the server using AJAX
    $.ajax({
        url: 'http://localhost:8080/api/project/addProjectLayout',
        type: 'POST',
        
        data: JSON.stringify(rowData),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': accessToken,
        },
        success: function (response) {
          console.log("projectname"+projectName);
            showalert('Data saved successfully!');
            console.log(response);
           
        },
        error: function (xhr, status, error) {
            showalert('Error occurred while saving data');
            console.error('Error:', error);
            console.error('Response:', xhr.responseText);
        }
    });
}

// Event listener for the submit button
$('#submitData').click(function() {
    submitFormData(); // Call the submitFormData function when the button is clicked
});
    // Function to fetch project layout data by projectId
    function fetchProjectLayout(projectId) {
      const accessToken = localStorage.getItem('accessToken');
 
        $.ajax({
            url: 'http://localhost:8080/api/project/getProjectLayoutByProId/' + projectId,
            type: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': accessToken,
            },
            success: function(response) {
                console.log('Response:', response); // Log the response to debug
                if (response) {
                    // Project layout exists, populate the data
                    console.log(response);
                    populateDataTable(response);
                    
                } else {
                    // Project layout does not exist, allow filling the form
                    console.log('Project layout not found. Allow filling the form.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error occurred while fetching data for projectId:', projectId);
                console.error('Error details:', error);
                console.error('Response from server:', xhr.responseText); // Log the response from the server
                showalert('Error occurred while fetching data for projectId ' + projectId + ': ' + error);
            }
        });
    }

    // Function to populate data into the dataTable
    function populateDataTable(responseData) {
      console.log(responseData);
        // Clear existing rows in the table
        $('#dataTable tbody').empty();
responseData.forEach(function(item)
{
        // Append a row to the table for the received project layout data
        var newRow = '<tr>' +
            '<td><input type="text" class="form-control" name="shape" value="' + item.shape + '"></td>' +
            '<td><input type="text" class="form-control" name="plotNumber" value="' + item.plotNumber + '"></td>' +
            '<td><input type="text" class="form-control" name="totalSqft" value="' + item.totalSqft + '"></td>' +
            '<td><input type="text" class="form-control" name="rate" value="' + item.rate + '"></td>' +
            '<td><input type="text" class="form-control" name="totalValue" readonly value="' + item.totalValue + '"></td>' +
            '<td><input type="text" class="form-control" name="msp" value="' + item.msp + '"></td>' +
            '<td><input type="text" class="form-control" name="descrip" value="' + item.descrip + '"></td>' +
            '<td><input type="text" class="form-control" name="status" value="' + item.status + '"></td>' +
            '</tr>';

        // Append the new row to the table body
        $('#dataTable tbody').append(newRow);
})
  }
    // Fetch projectId from URL parameters
    var projectId = getUrlParameter('projectId');
    var projectName =getUrlParameter('projectName');
    var teamId =getUrlParameter('teamId');
    console.log('Project ID:', projectId); // Log the projectId to debug
 
    console.log('Project Name:', projectName);
    if (projectId) {
        // If projectId is available in the URL, fetch data for that specific projectId
        fetchProjectLayout(projectId);

    } else {
        console.log('Project ID not found in URL.');
    }

    // Add an event listener for the totalValues column
    $('#dataTable tbody').on('keyup', 'input[name="totalSqft"], input[name="rate"]', function() {
        // Get the current row
        var currentRow = $(this).closest('tr');

        // Get the values of totalSQFT and rate from the current row
        var totalSqft = parseFloat(currentRow.find('input[name="totalSqft"]').val()) || 0;
        var rate = parseFloat(currentRow.find('input[name="rate"]').val()) || 0;

        // Calculate the totalValues by multiplying totalSQFT and rate
        var totalValues = totalSqft * rate;

        // Update the value of totalValues input field in the current row
        currentRow.find('input[name="totalValue"]').val(totalValues.toFixed(2)); // Assuming you want to round to 2 decimal places
    });

    // Add row functionality
    $('#addRow').click(function() {
        var newRow = '<tr class="new-row">' +
            '<td>' +
            '<select class="form-control" name="shape">' +
            '<option value="" disabled selected>Select a Shape</option>' +
            '<option value="Poly">Poly</option>' +
            '<option value="Rect">Rect</option>' +
            '<option value="Circle">Circle</option>' +
            '</select>' +
            '</td>' +
            '<td><input type="text" class="form-control" name="plotNumber"></td>' +
            '<td><input type="text" class="form-control" name="totalSqft"></td>' +
            '<td><input type="text" class="form-control" name="rate"></td>' +
            '<td><input type="text" class="form-control" name="totalValue" readonly></td>' +
            '<td><input type="text" class="form-control" name="msp"></td>' +
            '<td><input type="text" class="form-control" name="descrip"></td>' +
            '<td>' +
            '<select class="form-control" name="status">' +
            '<option value="" disabled selected>Select a Status</option>' +
            '<option value="Available Plot">Available Plot</option>' +
            '<option value="Freezed Plot">Freezed Plot</option>' +
            '<option value="Partially Paid Plot">Partially Paid Plot</option>' +
            '<option value="Sold Plot">Sold Plot</option>' +
            '</select>' +
            '</td>' +
            '</tr>';
        $('#dataTable tbody').append(newRow);
    });
});


  </script>
  
</body>

</html>
