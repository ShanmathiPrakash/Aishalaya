<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Employee List | Aishalaya</title>
  <link rel="shortcut icon" href="../../assets/images/aishLogo.ico" />

  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">

  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End Plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="http://127.0.0.1:5500/assets/css/style.css">
 
  <!-- End layout styles -->

  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">-->
  <script src="path/to/jquery.min.js"></script>
  <script src="path/to/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
 <!--showalert Message-->
 <script src="http://127.0.0.1:5500/assets/js/alertMessages.js"></script>
 
   

  <style>
    /* Adjust the modal size */
    .modal-dialog {
      max-width: 1100px;
      /* Set your desired maximum width */
    }

    /* Adjust the form size */
    .form-sample {
      max-width: 100%;
      /* Set your desired maximum width */
    }

    @media (min-width: 576px) {
      .col-sm-9 {
        -webkit-box-flex: 0;
        -ms-flex: 0 0 auto;
        flex: 0 0 auto;
        width: 100% !important;
      }
    }
  </style>
</head>

<body>
  <div class="container-scroller">

    <!-- partial:../../partials/_navbar.html -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
        <a class="navbar-brand brand-logo" href="../../index.html"><img src="../../assets/images/logo.png" alt="logo"
            style="height: 100%" /></a>
        <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="../../assets/images/logo.png"
            alt="logo" style="height: 100%" /></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="mdi mdi-menu"></span>
        </button>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item d-none d-lg-block full-screen-link">
            <a class="nav-link">
              <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
            </a>
          </li>
          <li class="nav-item nav-logout d-none d-lg-block">
            <a class="nav-link" onclick="logout()">
              <i class="mdi mdi-power"></i>
            </a>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
          data-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:../../partials/_sidebar.html -->
      <div id="includeHtml"></div>

      <div class="modal fade" id="employeeModal" tabindex="-1" role="dialog" aria-labelledby="employeeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="employeeModalLabel">
                Edit Employee
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeForm()">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Employee Form -->
              <form class="form-sample" id="employeeForm">
                <p class="card-description">Personal info</p>
                <div class="row">
                  <!-- ... (your existing form fields) ... -->
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="createdOn">createdon</label>
                      <div class="col-sm-6">
                        <input type="date" id="createdOn" name="createdOn" class="form-control" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="createdBy">createdby</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="text" id="createdBy" name="createdBy"
                          oninput="validateInput('createdBy')" /><br />
                      </div>
                    </div>
                  </div>
                  <!-- Add other form fields as needed -->

                  <!-- Add other form sections as needed -->

                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="employeeName">employeeName</label>
                      <div class="col-sm-6">
                        <input class="form-control" placeholder="employeeName" type="text" id="employeeName"
                          name="employeeName" oninput="validateInput('employeeName')" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="prefLocation">Preferred Location:</label>
                      <div class="col-sm-6">
                        <!-- <select class="form-control">
                              <option>Category1</option>
                              <option>Category2</option>
                              <option>Category3</option>
                              <option>Category4</option>
                            </select>
                            -->
                        <input type="text" id="prefLocation" name="prefLocation" class="form-control"
                          oninput="validateInput('prefLocation')" /><br />
                      </div>
                    </div>
                  </div>
                  <!--<div class="col-md-6">
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label">preflocation</label>
                          <div class="col-sm-4">
                            <div class="form-check">
                              <label class="form-check-label">
                                <input type="radio" class="form-check-input" name="membershipRadios" id="membershipRadios1" value="" checked> Free </label>
                            </div>
                          </div>
                         
                          <div class="col-sm-5">
                            <div class="form-check">
                              <label class="form-check-label">
                                <input type="radio" class="form-check-input" name="membershipRadios" id="membershipRadios2" value="option2"> Professional </label>
                            </div>
                          </div>
                        </div>
                      </div>-->

                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="employeeMobile">employeemobile</label>
                      <div class="col-sm-6">
                        <input type="text" id="employeeMobile" name="employeeMobile" class="form-control"
                          oninput="validateMobile(event)" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="alterMobile">altermobile</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="text" id="alterMobile" name="alterMobile"
                          oninput="validateMobile(event)" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row" for="employeeEmail">
                      <label class="col-sm-4 col-form-label">employeeemail</label>
                      <div class="col-sm-6">
                        <input type="text" class="form-control" id="employeeEmail" name="employeeEmail" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="dob">dob</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="date" id="dob" name="dob" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="gender">gender</label>
                      <div class="col-sm-6">
                        <select id="gender" name="gender" class="form-control">
                          <option value="male">Male</option>

                          <option value="female">Female</option>

                          <option value="other">Other</option>
                        </select><br />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="designation">designation</label>
                      <div class="col-sm-6">
                        <select id="designation" name="designation" class="form-control"></select><br />
                      </div>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="companyName">companyname</label>
                      <div class="col-sm-6">
                        <select id="companyName" name="companyName" class="form-control"></select><br />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="userName">username</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="userName" id="userName" name="userName" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="password">password</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="password" id="password" name="password" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="address1">
                        address1</label>
                      <div class="col-sm-6">
                        <input type="text" id="address1" name="address1" class="form-control" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="address2">address2</label>
                      <div class="col-sm-6">
                        <input type="text" id="address2" name="address2" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="area">area</label>
                      <div class="col-sm-6">
                        <input type="text" id="area" name="area" class="form-control" oninput="validateInput('area')" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="city">city</label>
                      <div class="col-sm-6">
                        <input class="form-control" type="text" id="city" name="city" oninput="validateInput('city')" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="district">district</label>
                      <div class="col-sm-6">
                        <input type="text" id="district" name="district" class="form-control"
                          oninput="validateInput('district')" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="state">state</label>
                      <div class="col-sm-6">
                        <input type="text" id="state" name="state" class="form-control"
                          oninput="validateInput('state')" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="pinCode">pincode</label>
                      <div class="col-sm-6">
                        <input type="text" id="pinCode" name="pinCode" class="form-control"
                          oninput="validatesInput(event)" />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="avatar">avatar</label>
                      <div class="col-sm-5">
                        <div id="avatarPath"></div>
                        <img id="avatarPreview" src="" style="
                              max-width: 100px;
                              max-height: 100px;
                              margin-top: 5px;
                            " />

                        <input class="form-control" type="file" id="avatar" name="avatar" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group row">
                      <label class="col-sm-4 col-form-label" for="isActive">is_active</label>
                      <div class="col-sm-6">
                        <select id="isActive" name="isActive" class="form-control">
                          <option value="Active">Active</option>
                          <option value="Inactive">Inactive</option>
                        </select><br />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Form buttons -->
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-gradient-primary me-2" value="submit">
                    Submit
                  </button>
                  <button type="button" class="btn btn-light" data-dismiss="modal" onclick="closeForm()">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">Employee List</h3>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../pages/dashboard/dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">
                  Employee List
                </li>
              </ol>
            </nav>
          </div>
          <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <div class="template-demo">
                    <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw"
                      onclick="window.location.href='employee_form.html';">
                      Add New
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table id="dataTable" class="table table-hover">
                      <thead>
                        <tr>
                          <th>Action</th>
                          <th>Employee Name</th>
                          <th>Email</th>
                          <th>Phone Number</th>
                          <th>Roles</th>
                          <th>Image</th>
                          
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Your table content -->
                      </tbody>
                    </table>
                  </div>
                  <ul id="pagination" class="pagination"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <div id="includeFooder"></div>
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
function logout() {
    // Clear local storage
    localStorage.clear();

    // Replace current state with a new state to prevent going back
    window.history.replaceState(null, "", window.location.href);

    // Add an event listener to handle the popstate event
    window.onpopstate = function (event) {
        // Push another state to forward the user
        window.history.pushState(null, "", window.location.href);
    };

    // Redirect to the logout page or perform other logout actions
    window.location.href = '../../index.html';
   }
   
    let isContentLoaded = false;

    document.addEventListener('DOMContentLoaded', async function () {

      const responseRoles = await fetch('http://localhost:8080/api/role/getRoles',{
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': accessToken,
          },
        });
        if (!responseRoles.ok) {
          throw new Error('Failed to fetch roles');
        }
    
        const roles = await responseRoles.json();
    const designationDropdown = document.getElementById('designation');
        roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role.roleId;
          option.textContent = role.role;
          designationDropdown.appendChild(option);
        });


      if (isContentLoaded) return; // Prevent multiple executions
      isContentLoaded = true;

      try {
        const accessToken = localStorage.getItem('accessToken');
        const employeeEmail = localStorage.getItem('employeeEmail');

        // Fetch employee details to get associated company ID
        const responseEmployee = await fetch('http://localhost:8080/api/employee/getEmployeeByEmail/' + employeeEmail, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': accessToken,
          },
        });

        if (!responseEmployee.ok) {
          throw new Error('Failed to fetch employee details');
        }

        const dataEmployee = await responseEmployee.json();

        // Ensure that the company object and companyId are properly fetched
        if (!dataEmployee.company || !dataEmployee.company.companyId) {
          throw new Error('Company ID not found in employee details');
        }

        const companyId = dataEmployee.company.companyId;

        // Check if the current URL already contains the company ID parameter
        if (!window.location.href.includes(`companyId=${companyId}`)) {
          // Redirect to the EmployeeForm page with company ID query parameter
          const formUrl = `employee_list.html?companyId=${companyId}`;
          window.location.href = formUrl;
        }
      } catch (error) {
        console.error('Error:', error);
        // Handle error
      }
    });

    

    var formData = new FormData();
    const accessToken = localStorage.getItem('accessToken');

    $(document).ready(function () {
      const accessToken = localStorage.getItem('accessToken');
      const urlParams = new URLSearchParams(window.location.search);
      const companyId = urlParams.get('companyId');
      console.log('Company ID:', companyId);

      const MainMenus = localStorage.getItem('MainMenus');

// Check permissions
const canEdit = MainMenus && MainMenus.includes('Employee List Edit');
const canView = MainMenus && MainMenus.includes('Employee List View');

      $.ajax({
        url: `http://localhost:8080/api/employee/getAllEmployeeDetails`,
        type: 'GET',
        dataType: 'json',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': accessToken,
        },
        success: function (employees) {
          console.log('All Employees:', employees);

          // Filter employees by companyId
          const filteredEmployees = employees.filter(employee => employee.company.companyId === parseInt(companyId));

          console.log('Filtered Employees:', filteredEmployees);

          // Clear existing table rows
          $('#dataTable tbody').empty();

          // Populate table with fetched data
          filteredEmployees.forEach(function (employee) {

            let buttons = '';

if (canEdit) {
    buttons += `
        <button type="button" class="btn btn-info btn-sm edit-btn" data-toggle="modal"
                                        data-target="#employeeModal" data-employee-id="${employee.employeeId}">Edit</button>
    `;
}

if (canView) {
    buttons += `
        <button type="button" class="btn btn-info btn-sm view-btn " data-toggle="modal"
                                        data-target="#employeeModal" data-employee-id="${employee.employeeId}">View</button>
    `;
}
            $('#dataTable tbody').append(`
                            <tr>
                                 <td>${buttons}</td>
                                <td>${employee.employeeName}</td>
                                <td>${employee.employeeEmail}</td>
                                <td>${employee.employeeMobile}</td>
                                <td>${employee.role.role}</td>
                                <td><img src="http://localhost:8080${employee.avatar}"></td>

                            </tr>
                        `);
          });

          $('#employeeModal').modal('hide');
        },
        error: function (xhr, status, error) {
          console.error('Error fetching employee details:', error);
          showalert('Error fetching employee details. Please try again later.');
        }
      });
    });

    function logout() {
      // Clear local storage
      localStorage.clear();

      // Redirect to the logout page or perform other logout actions
      window.location.href = '../../index.html';
    }

    function closeForm() {
      // Assuming 'employeeModal' is the ID of your modal
      $("#employeeModal").modal("hide");
    }

    const emailInput = document.getElementById('employeeEmail');
    const validationMessage = document.getElementById('validationMessage');
    // Regular expression to validate email addresses for the specified domains
    const emailRegex = /^[a-zA-Z0-9._%+-]+@(gmail\.com|yahoo\.com|outlook\.com|hotmail\.com|aol\.com|icloud\.com|protonmail\.com|zoho\.com|gmx\.com|yandex\.com|mail\.com)$/;

    emailInput.addEventListener('input', validateEmail);

    function validateEmail() {
      const email = emailInput.value;

      if (emailRegex.test(email)) {
        validationMessage.innerText = "Valid email address";
        validationMessage.style.color = "green";
      } else {
        validationMessage.innerText = "Invalid email address";
        validationMessage.style.color = "red";
      }
    }


    function submitForm(event) {
      event.preventDefault(); // Prevent default form submission behavior

      validateInput('createdBy');
      validateInput('employeeName');
      validateInput('prefLocation');
      validateInput('designation');
      validateInput('area');
      validateInput('city');
      validateInput('district');
      validateInput('state');

    }

    function validateInput(inputId) {
      const inputValue = document.getElementById(inputId).value;
      const alphaRegex = /^[a-zA-Z\s]+$/; // Regular expression to match only alphabetic characters and spaces
      const specialCharRegex = /[^a-zA-Z\s]/; // Regular expression to match any special characters

      if (specialCharRegex.test(inputValue) || !alphaRegex.test(inputValue)) {
        document.getElementById(inputId).style.borderColor = 'red'; // Set border color to red
        document.getElementById(inputId).setCustomValidity("Only alphabetic characters are allowed."); // Set validation message
        document.getElementById(inputId).reportValidity(); // Show validation message
      } else {
        document.getElementById(inputId).style.borderColor = ''; // Reset border color
        document.getElementById(inputId).setCustomValidity(""); // Clear validation message
      }
    }


    function validateMobile(event) {
      const inputValue = event.target.value;
      const numericRegex = /^[0-9]*$/; // Regular expression to match numeric characters

      if (!numericRegex.test(inputValue)) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Only numeric characters are allowed."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.replace(/\D/g, ''); // Remove non-numeric characters
      } else if (inputValue.length > 12) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Maximum length for mobile number is 12 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.slice(0, 12); // Truncate to 12 digits
      } else {
        event.target.style.borderColor = ''; // Reset border color
        event.target.setCustomValidity(""); // Clear validation message
      }
    }

    function validatesInput(event) {
      const inputValue = event.target.value;
      const numericRegex = /^[0-9]*$/; // Regular expression to match numeric characters

      if (!numericRegex.test(inputValue)) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Only numeric characters are allowed."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.replace(/\D/g, ''); // Remove non-numeric characters
      } else if (inputValue.length < 6) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Minimum length is 6 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
      } else if (inputValue.length > 6) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Maximum length is 6 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.slice(0, 6); // Truncate to 6 digits
      } else {
        event.target.style.borderColor = ''; // Reset border color
        event.target.setCustomValidity(""); // Clear validation message
      }
    }



   // Assuming you have an event listener for the edit buttons
   var currentEmployeeId;

function populateForm(employeeData, formData) {
  const createdOnDate = new Date(employeeData.createdOn);
  // Format the date to 'YYYY-MM-DD' (assuming you want this format)
  const formattedDate = createdOnDate.toISOString().split("T")[0];
  const dobDate = new Date(employeeData.dob);
  // Format the date to 'YYYY-MM-DD' (assuming you want this format)
  const formattedDob = dobDate.toISOString().split("T")[0];

  $("#createdOn").val(formattedDate);
  $("#createdBy").val(employeeData.createdBy);
  $("#employeeName").val(employeeData.employeeName);
  $("#prefLocation").val(employeeData.prefLocation);
  $("#employeeMobile").val(employeeData.employeeMobile);
  $("#alterMobile").val(employeeData.alterMobile);
  $("#employeeEmail").val(employeeData.employeeEmail);
  $("#dob").val(formattedDob);
  $("#gender").val(employeeData.gender);

  $("#designation").val(employeeData.role.roleId);
  // Fetch and save role values in the designation field

  $("#companyName").val(employeeData.company.companyId);
  $("#companyId").val(employeeData.company.companyId);
  $("#userName").val(employeeData.userName);
  $("#password").val(employeeData.password);
  $("#address1").val(employeeData.address1);
  $("#address2").val(employeeData.address2);
  $("#area").val(employeeData.area);
  $("#city").val(employeeData.city);
  $("#district").val(employeeData.district);
  $("#state").val(employeeData.state);
  $("#pinCode").val(employeeData.pinCode);
  $("#isActive").val(employeeData.isActive);


  // const employeeImage=employeeData.avatar;
  //           const 192.168.0.139EmployeeImage = 'http://192.168.0.139/' + employeeImage;
  // const employeeImageElement = document.getElementById('avatarPreview');

  // // Set the src attribute of the image element
  // employeeImageElement.src = 192.168.0.139EmployeeImage;


  const avatarPreview = document.getElementById("avatarPreview");

  if (avatarPreview) {
    // Display the avatar image using the File API
    const avatarFileInput = document.getElementById("avatar");

    if (avatarFileInput.files.length > 0) {
      const reader = new FileReader();

      reader.onload = function (e) {
        console.log("Image loaded successfully");
        avatarPreview.src = e.target.result;
      };

      reader.readAsDataURL(avatarFileInput.files[0]);
    }
  }
}

$(document).on("click", ".edit-btn", async function () {
  //

  const designationDropdown = document.getElementById('designation');
  const companyDropdown = document.getElementById('companyId');

  try {
    const accessToken = localStorage.getItem('accessToken');
    // Fetch roles from the backend
    const response = await fetch('http://localhost:8080/api/role/getRoles', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': accessToken,
      },
    });
    if (!response.ok) {
      throw new Error('Failed to fetch roles');
    }

    const roles = await response.json();

    // Populate the dropdown with roles
    roles.forEach(role => {
      const option = document.createElement('option');
      option.value = role.roleId;
      option.textContent = role.role;
      designationDropdown.appendChild(option);
    });
  } catch (error) {
    console.error('Error:', error);
    showalert('Failed to fetch roles');
  }





  const accessToken = localStorage.getItem('accessToken');
  currentEmployeeId = $(this).data("employee-id");
  var employeeId = $(this).data("employee-id");

  $.ajax({
    url: "http://localhost:8080/api/employee/getEmployeeById/" + employeeId,
    type: "GET",
    dataType: "json",
    headers: {
      'Content-Type': 'application/json',
      'Authorization': accessToken,
    },
    success: function (employeeData) {
      fetchRolesAndPopulateCompanyDropdown(function () {
        // Fetch roles and populate the designation dropdown first
        fetchRolesAndPopulateDesignationDropdown(function () {
          // Fetch gender and populate the gender dropdown
          fetchGenderAndPopulateDropdown(
            employeeData.gender,
            function () {
              // Once roles and gender are fetched and dropdowns are populated, populate the form
              fetchIsActiveAndPopulateDropdown(
                employeeData.isActive,
                function () {
                  populateForm(employeeData);
                  document.body.scrollTop = 0; // For Safari
                  document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE, and Opera
                  $("#employeeModal").modal("show");
                }
              );
            }
          );
        });
      });
    },
    error: function (xhr, status, error) {
      console.error(xhr.responseText);
      console.error(error);
      showalert("Error fetching employee details. Please try again later.");
    },
  });
});

function fetchGenderAndPopulateDropdown(selectedGender, callback) {
  // Assuming gender options are fixed, otherwise, you'd need to fetch them
  const genderOptions = ["Male", "Female"];
  const $genderDropdown = $("#gender");

  // Clear existing options
  $genderDropdown.empty();

  // Populate dropdown options
  genderOptions.forEach(function (gender) {
    $genderDropdown.append(
      `<option value="${gender}">${gender}</option>`
    );
  });

  // Set selected gender
  $genderDropdown.val(selectedGender);

  // Execute the callback function
  if (typeof callback === "function") {
    callback();
  }
}
function fetchIsActiveAndPopulateDropdown(selectedIsActive, callback) {
  // Define status options and corresponding values
  const isActiveOptions = [
    { label: "Active", value: "1" },
    { label: "Inactive", value: "0" },
  ];
  const $isActiveDropdown = $("#isActive");

  // Clear existing options
  $isActiveDropdown.empty();

  // Populate dropdown options
  isActiveOptions.forEach(function (option) {
    $isActiveDropdown.append(
      `<option value="${option.value}">${option.label}</option>`
    );
  });

  // Set selected status
  $isActiveDropdown.val(selectedIsActive);

  // Execute the callback function
  if (typeof callback === "function") {
    callback();
  }
}

function fetchRolesAndPopulateDesignationDropdown(callback) {
  const accessToken = localStorage.getItem('accessToken');
  $.ajax({
    url: "http://localhost:8080/api/role/getRoles",
    headers: {
      'Content-Type': 'application/json',
      'Authorization': accessToken,
    },
    type: "GET",
    dataType: "json",
    success: function (roles) {
      // Populate the designation dropdown with role names
      $("#designation").empty();
      roles.forEach(function (role) {
        $("#designation").append(
          `<option value="${role.roleId}">${role.role}</option>`
        );
      });

      // Execute the callback function
      if (typeof callback === "function") {
        callback();
      }
    },
    error: function (xhr, status, error) {
      console.error(xhr.responseText);
      console.error(error);
      showalert("Error fetching roles. Please try again later.");
    },
  });
}

let companyId; // Declare companyId variable outside the event listener
let designation;
function fetchRolesAndPopulateCompanyDropdown(callback) {
  const accessToken = localStorage.getItem('accessToken');
  // designation = designationDropdown.value;
  designation = document.getElementById("designation").value;
  $.ajax({
    url: "http://localhost:8080/api/superAdmin/company/getCompany",
    type: "GET",
    dataType: "json",
    headers: {
      'Content-Type': 'application/json',
      'Authorization': accessToken,
    },
    success: function (companies) {
      // Populate the company name dropdown with company names
      $("#companyName").empty();
      companies.forEach(function (company) {
        $("#companyName").append(
          `<option value="${company.companyId}">${company.companyName}</option>`
        );
      });

      // Execute the callback function
      if (typeof callback === "function") {
        callback();
      }
    },
    error: function (xhr, status, error) {
      console.error(xhr.responseText);
      console.error(error);
      showalert("Error fetching companies. Please try again later.");
    },
  });
}

    document.getElementById("employeeForm").addEventListener("submit", async function (event) {
        event.preventDefault();
        const formData = new FormData();
        var employeeId = currentEmployeeId;
        const companyIdParam = new URLSearchParams(window.location.search).get('companyId');
      const designation = document.getElementById('designation').value;
        console.log(document.getElementById("isActive").value);
        const employeeData = {
          createdOn: document.getElementById("createdOn").value,
          createdBy: document.getElementById("createdBy").value,
          employeeName: document.getElementById("employeeName").value,
          prefLocation: document.getElementById("prefLocation").value,
          employeeMobile: document.getElementById("employeeMobile").value,
          alterMobile: document.getElementById("alterMobile").value,
          employeeEmail: document.getElementById("employeeEmail").value,
          dob: document.getElementById("dob").value,
          gender: document.getElementById("gender").value,
         
          role: { roleId: designation},
          company: {
            companyId: companyIdParam,
          },
          userName: document.getElementById("userName").value,
          password: document.getElementById("password").value,
          address1: document.getElementById("address1").value,
          address2: document.getElementById("address2").value,
          area: document.getElementById("area").value,
          city: document.getElementById("city").value,
          district: document.getElementById("district").value,
          state: document.getElementById("state").value,
          pinCode: document.getElementById("pinCode").value,
          isActive: document.getElementById("isActive").value,
        };

        formData.append(
          "employee",
          new Blob([JSON.stringify(employeeData)], {
            type: "application/json",
          })
        );

        const avatarFileInput = document.getElementById("avatar");
        if (avatarFileInput.files.length > 0) {
          formData.append("logoFile", avatarFileInput.files[0]);
        }
        const accessToken = localStorage.getItem('accessToken');
        console.log("formData", formData);
        $.ajax({
          url: "http://localhost:8080/api/employee/updateEmployee/" + currentEmployeeId,
          type: "PUT",
          data: formData,
          contentType: false, // Prevent jQuery from setting the content type header
      processData: false, 

          headers: {
            'Authorization': accessToken
          },
          success: function (response) 
          {
            showalert("Employee Details updated successfully" ,function(){
            window.location.href = "employee_list.html";
            });
          },
          error: function (xhr, status, error) {
            console.error("Error updating employee:", error);
            showalert("Error updating employee. Please try again.");
          },
        });
      });




    $(document).ready(function () {
      $('#createdBy,#employeeName,#prefLocation,#gender,#area,#city,#district,#state').on('input', function () {
        var inputValue = $(this).val();
        // Check if the input contains any numeric characters
        if (/\d/.test(inputValue)) {
          showalert('Please enter alphabetic characters only.');
          // Remove the numeric characters
          $(this).val(inputValue.replace(/\d/g, ''));
        }
        if (/[^\w\s]/.test(inputValue)) {
          showalert('Special characters are not allowed.');
          // Remove the special characters
          $(this).val(inputValue.replace(/[^\w\s]/g, ''));
        }
        // Check if the input length exceeds the limit
        if (inputValue.length > 100) {
          showalert('Maximum length exceeded. Please enter up to 50 characters.');
          // Trim the input to the maximum length
          $(this).val(inputValue.slice(0, 50));
        }
      });
    });
    $(document).ready(function () {
      $('#alterMobile,#employeeMobile').on('input', function () {
        var phoneNumber = $(this).val();

        // Check if the input contains letters or special characters
        if (/[^\d]/.test(phoneNumber)) {
          showalert('Please enter digits only.');
          phoneNumber = phoneNumber.replace(/[^\d]/g, '');
        }

        // Remove any non-digit characters
        phoneNumber = phoneNumber.replace(/\D/g, '');

        // Limit to 12 digits
        if (phoneNumber.length > 12) {
          showalert('Please enter a maximum of 12 digits.');
          phoneNumber = phoneNumber.substr(0, 12);
        }

        $(this).val(phoneNumber);
      });
    });

    $(document).ready(function () {
      $('#pinCode').on('input', function () {
        var postalCode = $(this).val();
        // Check if input contains non-numeric characters or more than 6 digits
        if (/\D/.test(postalCode) || postalCode.length > 6) {
          showalert('Please enter exactly 6 digits numerics only.');
          // Remove non-numeric characters and extra digits
          postalCode = postalCode.replace(/\D/g, '').substr(0, 6);
          $(this).val(postalCode);
        }
      });
    });

    $(document).ready(function () {
      $('#employeeEmail').on('input', function () {
        var inputValue = $(this).val();
        // Check if the input contains any numeric character
        // Check if the input contains any spaces
        if (/\s/.test(inputValue)) {
          showalert('Spaces are not allowed.');
          // Remove the spaces
          $(this).val(inputValue.replace(/\s/g, ''));
        }
        // Check if the input length exceeds the limit
        if (inputValue.length > 50) {
          showalert('Maximum length exceeded. Please enter up to 100 characters.');
          // Trim the input to the maximum length
          $(this).val(inputValue.slice(0, 100));
        }
      });
    });
    $(document).ready(function () {
      $('#userName,#password,address1,address2').on('input', function () {
        var inputValue = $(this).val();
        // Check if the input contains any numeric characters


        // Check if the input length exceeds the limit
        if (inputValue.length > 50) {
          showalert('Maximum length exceeded. Please enter up to 50 characters.');
          // Trim the input to the maximum length
          $(this).val(inputValue.slice(0, 50));

        }
      });
    });

  </script>

  <!-- plugins:js -->
<script src="../../assets/vendors/js/vendor.bundle.base.js"></script></script>
 */
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <script src="../../assets/vendors/chart.js/Chart.min.js"></script>
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="../../assets/js/off-canvas.js"></script>
  <script src="../../assets/js/hoverable-collapse.js"></script>
  <!-- <script src="../../assets/js/pagination.js"></script> -->
  <script src="../../assets/js/menu_active.js"></script>
  <script src="../../assets/js/misc.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <script src="../../assets/js/chart.js"></script>
  <!-- End custom js for this page -->
</body>

</html>