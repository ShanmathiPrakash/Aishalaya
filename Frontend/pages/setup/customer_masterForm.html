<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Customer Form | Aishalaya</title>
    <link rel="shortcut icon" href="../../assets/images/aishLogo.ico"/>
    
  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css"><!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="http://127.0.0.1:5500/assets/css/style.css">
 
    <!-- End layout styles -->
    <!--showalert Message-->
    <script src="http://127.0.0.1:5500/assets/js/alertMessages.js"></script>
 
   
  </head>
  <body>
    <div class="container-scroller" >
      <!-- partial:../../partials/_navbar.html -->
      <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
        <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
          <a class="navbar-brand brand-logo" href="../../index.html"><img src="../../assets/images/logo.png" alt="logo" style="height: 100%;"/></a>
          <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="../../assets/images/logo.png" alt="logo" style="height: 100%;"/></a>
        </div>
        <div class="navbar-menu-wrapper d-flex align-items-stretch">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-menu"></span>
          </button>
          <ul class="navbar-nav navbar-nav-right">
            <li class="nav-item d-none d-lg-block full-screen-link">
              <a class="nav-link">
                <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
              </a>
            </li>
            <li class="nav-item nav-logout d-none d-lg-block">
              <a class="nav-link" onclick="logout()">
                <i class="mdi mdi-power"></i>
              </a>
            </li>
  
          </ul>
          <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
            <span class="mdi mdi-menu"></span>
          </button>
        </div>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <div id="includeHtml"></div>
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="page-header">
              <h3 class="page-title"> Customer Form </h3>
              <nav aria-label="breadcrumb"></nav>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <!-- <h4 class="card-title">Customer</h4> -->
                    <form class="form-sample" id="customerForm">
                      <!-- <p class="card-description">Customer Info</p> -->
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-3 col-form-label" for="date">Date</label>
                            <div class="col-sm-9">
                              <input class="form-control" type="date" id="date" name="date" readonly />
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="customerName">Customer Name <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input class="form-control" type="text" id="customerName" name="customerName" maxlength="50" oninput="validateInput('customerName')" placeholder="Customer Name" required/>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="employeeName">Employee</label>
                            <div class="col-sm-9">
                              <input type="text" id="employeeName" name="employeeName" class="form-control"  placeholder="employeeName" readonly/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="employeeCode">Employee Email</label>
                            <div class="col-sm-9">
                              <input type="text" id="employeeCode" name="employeeCode" class="form-control"  placeholder="Employee code" readonly/>
                            </div>
                          </div>
                        </div>
                        

                      </div>
                        
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="mobileNumber">Mobile Number <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="mobileNumber" name="mobileNumber" class="form-control" oninput="validateMobile('event')" required placeholder="Mobile number"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                          <label class="col-sm-9 col-form-label" for="companyId">Company<span class="text-danger">*</span></label>
                          <div class="col-sm-9">
                          <select id="companyId" name="companyId" required class="form-control">
                          <option value="" disabled selected>
                          Select Team
                          </option>
                          </select><br />
                          </div>
                          </div>
                          </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="address">Address</label>
                            <div class="col-sm-9">
                              <input type="text" id="address" name="address" class="form-control" maxlength="100" placeholder="Address"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="streetName">Street Name</label>
                            <div class="col-sm-9">
                              <input type="text" id="streetName" name="streetName" class="form-control" maxlength="100" placeholder="Street name"/>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="area">Area <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="area" name="area" class="form-control"maxlength="50"oninput="validateNo('area')" required placeholder="Area"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="city">City <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="city" name="city" class="form-control" maxlength="50" oninput="validateInput('city')" required placeholder="City"/>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="district">District <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="district" name="district" class="form-control" maxlength="50" oninput="validateInput('district')" required  placeholder="District"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="state">State <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="state" name="state" class="form-control" maxlength="50"oninput="validateInput('state')" required placeholder="State"/>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="postalCode">Postal Code <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="postalCode" name="postalCode" class="form-control"  placeholder="Postal code" maxlength="6"oninput="validatesInput(event)" required/>
                            </div>
                          </div>
                        </div>
                        

                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="customerEmail">Customer Email </label>
                            <div class="col-sm-9">
                              <input type="text" id="customerEmail" name="customerEmail" class="form-control"  placeholder="Customer Email"/>
                              <p id="validationMessage"></p>
                            </div>
                          </div>
                        </div>
                        

                        

                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="password">Password <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="text" id="password" name="password" class="form-control"  placeholder="Password" required/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-9 col-form-label" for="employeeType">Occupation</label>
                            <div class="col-sm-9">
                              <input class="form-control" type="text" id="employeeType" name="employeeType" maxlength="50" placeholder="Employee type"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-3 col-form-label" for="workPlace">Work Place</label>
                            <div class="col-sm-9">
                              <input class="form-control" type="text" id="workPlace" name="workPlace" maxlength="50" placeholder="Work place"/>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-sm-3 col-form-label" for="image">Image <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                              <input type="file" id="image" name="image" class="form-control" placeholder="Image" required/>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div>
                      <div class="col-md-6">
                        <div class="form-group row">
                          <label class="col-sm-9 col-form-label" for="location">Location <span class="text-danger">*</span></label>
                          <div class="col-sm-9">
                            <input type="text" id="location" name="location" class="form-control" maxlength="100" placeholder="Location" required/>
                          </div>
                        </div>
                      </div>
                    </div>
                      <div class="d-flex justify-content-end">
                        <!-- <button type="button" class="btn back custom-width" onclick="window.location.href='site_visit_form.html';">Back</button> -->
                        <button type="submit" class="btn btn-gradient-primary me-2" value="submit">Submit</button>
                        <a href="customer_list.html" class="btn btn-light">Cancel</a>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Other code... -->
<script>
  
  function logout() {
    // Clear local storage
    localStorage.clear();

    // Replace current state with a new state to prevent going back
    window.history.replaceState(null, "", window.location.href);

    // Add an event listener to handle the popstate event
    window.onpopstate = function (event) {
        // Push another state to forward the user
        window.history.pushState(null, "", window.location.href);
    };

    // Redirect to the logout page or perform other logout actions
    window.location.href = '../../index.html';
   }

  /*checking the duplication with the customer Mobile Number*/
  function validateMobile(event) {
    const inputValue = event.target.value;
    console.log("inputValue",inputValue);
    const numericRegex = /^[0-9]*$/; // Regular expression to match numeric characters

    if (!numericRegex.test(inputValue)) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Only numeric characters are allowed."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.replace(/\D/g, ''); // Remove non-numeric characters
    } else if (inputValue.length > 12) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Maximum length for mobile number is 12 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.slice(0, 12); // Truncate to 12 digits
    } else {
        event.target.style.borderColor = ''; // Reset border color
        event.target.setCustomValidity(""); // Clear validation message
    }
}
  async function checkDuplicateMobile(currentMobileNumber) {

                 const accessToken = localStorage.getItem('accessToken');
                  try {
                      const response = await fetch(`http://localhost:8080/api/customer/getCustomerByPhoneNumber/${currentMobileNumber}`, {
                          method: 'GET',
                          credentials: 'include',
                          headers: {
                          'Content-Type': 'application/json',
                          'Authorization': accessToken,
                  },
                      });
                      if (!response.ok) {
                          return false;
                          throw new Error('Error checking duplicate Mobile Number');
                          
                      }
                      const data = await response.json();
                    
                      if (data !== null) 
                      {
                        // Display showalert for duplicate GST
                      //  showalert('Duplicate GST number. Please enter a unique GST number.');
                      showalert('Mobile Number is already registered.');
                      return true;
                      }
                      return false;
                  } catch (error) {
                     // console.error('Error:', error);
                      
                  }
              }
          /**/

const emailInput = document.getElementById('customerEmail');

const validationMessage = document.getElementById('validationMessage');
// Regular expression to validate email addresses for the specified domains
const emailRegex = /^[a-zA-Z0-9._%+-]+@(gmail\.com|yahoo\.com|outlook\.com|hotmail\.com|aol\.com|icloud\.com|protonmail\.com|zoho\.com|gmx\.com|yandex\.com|mail\.com)$/;

emailInput.addEventListener('input', validateEmail);

function validateEmail() {
    const email = emailInput.value;

    if (emailRegex.test(email)) {
        validationMessage.innerText = "Valid email address";
        validationMessage.style.color = "green";
    } else {
        validationMessage.innerText = "Invalid email address";
        validationMessage.style.color = "red";
    }
}

function validatesInput(event) {
    const inputValue = event.target.value;
    const numericRegex = /^[0-9]*$/; // Regular expression to match numeric characters

    if (!numericRegex.test(inputValue)) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Only numeric characters are allowed."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.replace(/\D/g, ''); // Remove non-numeric characters
    } else if (inputValue.length < 6) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Minimum length is 6 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
    } else if (inputValue.length > 6) {
        event.target.style.borderColor = 'red'; // Set border color to red
        event.target.setCustomValidity("Maximum length is 6 digits."); // Set validation message
        event.target.reportValidity(); // Show validation message
        event.target.value = inputValue.slice(0, 6); // Truncate to 6 digits
    } else {
        event.target.style.borderColor = ''; // Reset border color
        event.target.setCustomValidity(""); // Clear validation message
    }
}

let isContentLoaded = false;

document.addEventListener('DOMContentLoaded', async function() {
  const employeeEmail=localStorage.getItem('employeeEmail');
  const employeeName=localStorage.getItem('employeeName');
  const companyDropdown=document.getElementById('companyId');


  const currentDate = new Date();
    const year = currentDate.getFullYear();
    let month = (currentDate.getMonth() + 1).toString().padStart(2, '0'); // Months are zero-based, so add 1
    let day = currentDate.getDate().toString().padStart(2, '0');

    const dateString = `${year}-${month}-${day}`;
    
    document.getElementById('date').value = dateString; // Set the value attribute with the formatted date string
   
document.getElementById('employeeCode').value=employeeEmail;
    
document.getElementById('employeeName').value=employeeName;
  if (isContentLoaded) return; // Prevent multiple executions
  isContentLoaded = true;

  try {
    const accessToken = localStorage.getItem('accessToken');
    const employeeEmail = localStorage.getItem('employeeEmail');
    
    // Fetch employee details to get associated company ID
    const responseEmployee = await fetch('http://localhost:8080/api/employee/getEmployeeByEmail/' + employeeEmail, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': accessToken,
      },
    });
    
    
    // Remaining code for fetching roles and populating dropdowns
    // ...
  } catch (error) {
    console.error('Error:', error);
    // Handle error
  }
//company dropdown
const accessToken = localStorage.getItem('accessToken');
try {
const response = await fetch(
"http://localhost:8080/api/company/getCompany",
{
method: "GET",
headers: {
"Content-Type": "application/json",
Authorization: accessToken,
},
}
);

if (!response.ok) {
throw new Error("Failed to fetch team details");
}

const companyDatas = await response.json();
companyDropdown.innerHTML = "";

companyDatas.forEach((companyData) => {
const option = document.createElement("option");
option.value = companyData.companyId;
option.textContent = companyData.companyName;
companyDropdown.appendChild(option);
});

console.log("Fetched teams:", teamData);
} catch (error) {
console.error("Error fetching team details:", error);
}



});

  function logout() {
    // Clear local storage
    localStorage.clear();
    
    // Redirect to the logout page or perform other logout actions
    window.location.href = '../../index.html';
}

document.addEventListener('DOMContentLoaded', function() {

  const mobileNumberInput = document.getElementById('mobileNumber');
    mobileNumberInput.addEventListener('input', validateMobile);
            // Add event listeners for form submission
            document.getElementById('customerForm').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission behavior
                validateForm();
            });
        });

        function validateForm() {
            // Validate individual fields
            validateNo('area');
            validateInput('customerName');
            validateInput('city');
            validateInput('district');
            validateInput('state');
            // Additional validation logic can be added here
        }
       // const companyData = await responseCompany.json();
      

   function validateNo(inputId) {
            const inputField = document.getElementById(inputId);
            const inputValue = inputField.value;
            const NoRegex = /^[A-Za-z0-9\s]*$/; // Regular expression to allow alphabets, numbers, and spaces

            if (!NoRegex.test(inputValue)) {
                inputField.style.borderColor = 'red'; // Set border color to red
                inputField.setCustomValidity("Please enter numbers and alphabets only."); // Set custom validation message
                inputField.reportValidity(); // Show validation message
            } else {
                inputField.style.borderColor = ''; // Reset border color
                inputField.setCustomValidity(""); // Clear custom validation message
            }
        }

        function validateInput(inputId) {
            const inputValue = document.getElementById(inputId).value;
            const alphaRegex = /^[a-zA-Z\s]+$/; // Regular expression to match only alphabetic characters and spaces
            const specialCharRegex = /[^a-zA-Z\s]/; // Regular expression to match any special characters
            
            if (specialCharRegex.test(inputValue) || !alphaRegex.test(inputValue)) {
                document.getElementById(inputId).style.borderColor = 'red'; // Set border color to red
                document.getElementById(inputId).setCustomValidity("Only alphabetic characters are allowed."); // Set validation message
                document.getElementById(inputId).reportValidity(); // Show validation message
            } else {
                document.getElementById(inputId).style.borderColor = ''; // Reset border color
                document.getElementById(inputId).setCustomValidity(""); // Clear validation message
            }
        }


document.getElementById('customerForm').addEventListener('submit', async function (event) {
              event.preventDefault();
              const currentMobileNumber=document.getElementById('mobileNumber').value;
              const isDublicate= await checkDuplicateMobile(currentMobileNumber);
              if(isDublicate)
              {
                return;
              }
              const formData = new FormData();
              const companyData = {
                date: document.getElementById('date').value,
                customerName: document.getElementById('customerName').value,
                employeeCode: document.getElementById('employeeCode').value,
                companyId: document.getElementById('companyId').value,
                mobileNumber: document.getElementById('mobileNumber').value,
                location: document.getElementById('location').value,
                address: document.getElementById('address').value,
                streetName: document.getElementById('streetName').value,
                area: document.getElementById('area').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                customerEmail: document.getElementById('customerEmail').value,
                password: document.getElementById('password').value,
                employeeType: document.getElementById('employeeType').value,
                workPlace: document.getElementById('workPlace').value,
                employeeName: document.getElementById('employeeName').value,
           
              };

              formData.append('customer', new Blob([JSON.stringify(companyData)], { type: 'application/json' }));

              const image = document.getElementById('image');

                      if (image.files.length > 0)
                       {
                        // Append avatar file to formData
                        formData.append('image', image.files[0]);
                      }
        
                     
        
              try {
                const accessToken = localStorage.getItem('accessToken');
                const response = await fetch('http://localhost:8080/api/customer/addCustomer', {
                  method: 'POST',
                  body: formData,
                  processData: false,
                  contentType:  false,
                  headers: {
                  'Authorization': accessToken,
                },
                  
                });
        
                if (!response.ok) {
                  showalert('Failed to add new customer');
                  throw new Error('Failed to add new customer');
                 
                }
                showalert('Customer Details updated successfully', function() {
                window.location.href = "customer_masterList.html";
            });
                // Optionally, redirect or perform any other action upon successful submission
              } catch (error) {
                console.error('Error:', error);
                //showalert('Failed to add company');
              }
            });

          //    $(document).ready(function(){
                
          //  });

          </script>
          <!-- Other code... -->
        </div>
        
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- plugins:js -->
  <script src="../../assets/vendors/js/vendor.bundle.base.js"></script></script>
 */
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="../../assets/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/hoverable-collapse.js"></script>
    <!-- <script src="../../assets/js/pagination.js"></script> -->  
    <script src="../../assets/js/menu_active.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="../../assets/js/chart.js"></script>
  </body>
</html> 

